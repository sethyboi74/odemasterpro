<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>CodeMaster Pro - Code Analysis & Development Hub</title>
      <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&display=swap');

        :root {
        --bg-primary: #0a0b0f;
        --bg-secondary: #0f1419;
        --bg-tertiary: #161b22;
        --bg-elevated: #21262d;
        --text-primary: #f0f6fc;
        --text-secondary: #b1bac4;
        --text-muted: #7d8590;
        --accent-primary: #58a6ff;
        --accent-secondary: #238636;
        --accent-warning: #d29922;
        --accent-danger: #f85149;
        --accent-purple: #bc8cff;
        --accent-teal: #39d0d8;
        --border-default: #30363d;
        --border-muted: #21262d;
        --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.2);
        --radius-md: 8px;
        --radius-lg: 12px;
        --radius-xl: 16px;
        --font-mono: 'JetBrains Mono', 'Fira Code', Consolas, monospace;
        --font-sans: 'Inter', system-ui, -apple-system, sans-serif;
        }

        * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        }

        body {
        background: linear-gradient(135deg, #0a0b0f 0%, #1a1b23 100%);
        color: var(--text-primary);
        font-family: var(--font-sans);
        line-height: 1.5;
        overflow-x: hidden;
        }

        .toolbar {
        background: linear-gradient(135deg, rgba(88, 166, 255, 0.1) 0%, rgba(188, 140, 255, 0.1) 100%);
        border-bottom: 1px solid var(--border-default);
        padding: 16px 24px;
        backdrop-filter: blur(12px);
        position: sticky;
        top: 0;
        z-index: 1000;
        }

        .toolbar-content {
        max-width: 1600px;
        margin: 0 auto;
        display: flex;
        align-items: center;
        justify-content: space-between;
        }

        .toolbar-brand {
        display: flex;
        align-items: center;
        gap: 12px;
        }

        .brand-icon {
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, var(--accent-primary), var(--accent-purple));
        border-radius: var(--radius-lg);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        font-weight: 700;
        color: white;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .brand-text h1 {
        font-size: 24px;
        font-weight: 700;
        background: linear-gradient(135deg, var(--accent-primary), var(--accent-purple));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        }

        .brand-subtitle {
        font-size: 12px;
        color: var(--text-secondary);
        }

        .toolbar-nav {
        display: flex;
        gap: 8px;
        align-items: center;
        }

        .nav-link {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 16px;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid var(--border-muted);
        border-radius: var(--radius-md);
        color: var(--text-secondary);
        text-decoration: none;
        font-size: 13px;
        font-weight: 500;
        transition: all 0.2s ease;
        cursor: pointer;
        }

        .nav-link:hover, .nav-link.active {
        background: rgba(88, 166, 255, 0.1);
        border-color: var(--accent-primary);
        color: var(--text-primary);
        transform: translateY(-1px);
        }

        .toolbar-stats {
        display: flex;
        gap: 12px;
        }

        .stat-pill {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid var(--border-muted);
        border-radius: var(--radius-md);
        padding: 6px 12px;
        font-size: 11px;
        color: var(--text-muted);
        }

        .main-container {
        max-width: 1600px;
        margin: 0 auto;
        padding: 24px;
        display: grid;
        grid-template-columns: 400px 1fr;
        gap: 24px;
        min-height: calc(100vh - 80px);
        }

        .panel {
        background: linear-gradient(145deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
        border: 1px solid var(--border-default);
        border-radius: var(--radius-xl);
        padding: 20px;
        box-shadow: var(--shadow-lg);
        backdrop-filter: blur(12px);
        position: relative;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        }

        .panel::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: linear-gradient(90deg, var(--accent-primary), var(--accent-purple), var(--accent-teal));
        }

        .panel-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 20px;
        }

        .panel-icon {
        width: 24px;
        height: 24px;
        color: var(--accent-primary);
        }

        .panel-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-primary);
        }

        .section {
        margin-bottom: 20px;
        }

        .section-title {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 16px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 12px;
        padding-bottom: 8px;
        border-bottom: 1px solid var(--border-muted);
        }

        .template-selector {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        margin-bottom: 16px;
        }

        .template-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
        padding: 12px 8px;
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid var(--border-muted);
        border-radius: var(--radius-md);
        color: var(--text-secondary);
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 12px;
        text-align: center;
        }

        .template-btn:hover {
        background: rgba(255, 255, 255, 0.05);
        transform: translateY(-1px);
        }

        .template-btn.selected {
        background: rgba(88, 166, 255, 0.1);
        border-color: var(--accent-primary);
        color: var(--text-primary);
        }

        .template-icon {
        font-size: 18px;
        margin-bottom: 4px;
        }

        .search-container {
        position: relative;
        margin-bottom: 12px;
        }

        .search-input {
        width: 100%;
        padding: 10px 40px 10px 12px;
        background: var(--bg-primary);
        border: 1px solid var(--border-default);
        border-radius: var(--radius-md);
        color: var(--text-primary);
        font-family: var(--font-mono);
        font-size: 12px;
        outline: none;
        transition: all 0.2s ease;
        }

        .search-input:focus {
        border-color: var(--accent-primary);
        box-shadow: 0 0 0 2px rgba(88, 166, 255, 0.1);
        }

        .search-btn {
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: var(--text-muted);
        cursor: pointer;
        padding: 4px;
        border-radius: 4px;
        transition: all 0.2s ease;
        }

        .search-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        color: var(--accent-primary);
        }

        .search-results {
        /* show more than ~2 tall rows but keep it sensible */
        /* clamp(min=280px, preferred=60vh, max=600px) for broad support */
        max-height: 60vh;
        overflow-y: auto;
        background: var(--bg-primary);
        border: 1px solid var(--border-default);
        border-radius: var(--radius-md);
        display: none;
        }

        /* keep result items on a single line so height stays compact */
        .search-result {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        border-bottom: 1px solid var(--border-muted);
        cursor: pointer;
        transition: all 0.2s ease;
        flex-wrap: nowrap; /* <— add this */
        }

        .search-results.show {
        display: block;
        }

        .search-result {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        border-bottom: 1px solid var(--border-muted);
        cursor: pointer;
        transition: all 0.2s ease;
        }

        .search-result:hover {
        background: rgba(255, 255, 255, 0.03);
        }

        .search-result:last-child {
        border-bottom: none;
        }

        .result-line {
        font-size: 11px;
        color: var(--accent-teal);
        min-width: 40px;
        text-align: center;
        background: rgba(57, 208, 216, 0.1);
        padding: 2px 6px;
        border-radius: 4px;
        }

        .result-code {
        flex: 1;
        font-family: var(--font-mono);
        font-size: 11px;
        color: var(--text-secondary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        }

        .result-code mark {
        background: rgba(88, 166, 255, 0.3);
        color: var(--text-primary);
        padding: 1px 2px;
        border-radius: 2px;
        }

        .result-actions {
        display: flex;
        gap: 4px;
        }

        .result-btn {
        padding: 4px 8px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--border-muted);
        border-radius: 4px;
        color: var(--text-secondary);
        font-size: 10px;
        cursor: pointer;
        transition: all 0.2s ease;
        }

        .result-btn:hover {
        background: rgba(88, 166, 255, 0.1);
        color: var(--accent-primary);
        }

        .upload-area {
        border: 2px dashed var(--border-default);
        border-radius: var(--radius-lg);
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: linear-gradient(145deg, rgba(88, 166, 255, 0.03) 0%, rgba(188, 140, 255, 0.03) 100%);
        margin-bottom: 16px;
        }

        .upload-area:hover {
        border-color: var(--accent-primary);
        background: linear-gradient(145deg, rgba(88, 166, 255, 0.08) 0%, rgba(188, 140, 255, 0.08) 100%);
        transform: translateY(-2px);
        }

        .upload-area.dragover {
        border-color: var(--accent-teal);
        background: linear-gradient(145deg, rgba(57, 208, 216, 0.1) 0%, rgba(88, 166, 255, 0.1) 100%);
        }

        .upload-icon {
        font-size: 24px;
        margin-bottom: 8px;
        }

        .upload-text {
        font-size: 14px;
        font-weight: 500;
        margin-bottom: 4px;
        }

        .upload-hint {
        font-size: 12px;
        color: var(--text-muted);
        }

        .file-input {
        display: none;
        }

        .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        padding: 8px 14px;
        border: 1px solid var(--border-default);
        border-radius: var(--radius-md);
        background: var(--bg-elevated);
        color: var(--text-primary);
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        text-decoration: none;
        }

        .btn:hover:not(:disabled) {
        transform: translateY(-1px);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12);
        }

        .btn.primary {
        background: linear-gradient(135deg, var(--accent-primary), var(--accent-purple));
        border-color: transparent;
        color: white;
        font-weight: 600;
        }

        .btn.secondary {
        background: linear-gradient(135deg, var(--accent-secondary), var(--accent-teal));
        border-color: transparent;
        color: white;
        font-weight: 600;
        }

        .btn.warning {
        background: linear-gradient(135deg, var(--accent-warning), #f59e0b);
        border-color: transparent;
        color: white;
        font-weight: 600;
        }

        .btn.small {
        padding: 6px 10px;
        font-size: 11px;
        }

        .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none !important;
        }

        .btn-group {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        }

        .code-editor {
        background: var(--bg-primary);
        border: 1px solid var(--border-default);
        border-radius: var(--radius-lg);
        overflow: hidden;
        flex: 1;
        display: flex;
        flex-direction: column;
        margin-bottom: 20px;
        }

        .editor-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px;
        background: var(--bg-elevated);
        border-bottom: 1px solid var(--border-default);
        }

        .editor-title {
        font-size: 12px;
        font-weight: 600;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        }

        .editor-controls {
        display: flex;
        gap: 8px;
        }
        .editor-content {
        flex: 1;
        display: flex;
        height: 500px;
        max-height: 500px;
        overflow-y: auto;
        }

        .line-numbers {
        width: 60px;
        background: var(--bg-primary);
        border-right: 1px solid var(--border-default);
        color: var(--text-muted);
        font-family: var(--font-mono);
        font-size: 12px;
        padding: 12px 8px;
        text-align: right;
        user-select: none;
        overflow: hidden;
        line-height: 1.6;
        }

        .code-textarea {
        flex: 1;
        background: var(--bg-primary);
        border: none;
        color: var(--text-primary);
        font-family: var(--font-mono);
        font-size: 12px;
        padding: 12px;
        resize: none;
        outline: none;
        line-height: 1.6;
        white-space: pre;
        overflow: auto;
        }

        .code-display {
        flex: 1;
        background: var(--bg-primary);
        color: var(--text-primary);
        font-family: var(--font-mono);
        font-size: 12px;
        padding: 12px;
        white-space: pre;
        overflow: auto;
        line-height: 1.6;
        }

        .highlight-line {
        background: #243149 !important;
        outline: 2px solid var(--accent-primary);
        box-shadow: 0 0 0 2px rgba(88, 166, 255, 0.3) inset;
        animation: pulse-highlight 2s ease-out;
        }

        @keyframes pulse-highlight {
        0% { box-shadow: 0 0 0 4px rgba(88, 166, 255, 0.6) inset; }
        100% { box-shadow: 0 0 0 2px rgba(88, 166, 255, 0.3) inset; }
        }

        .preview-window {
        background: var(--bg-primary);
        border: 1px solid var(--border-default);
        border-radius: var(--radius-lg);
        height: 900px;
        overflow: hidden;
        }

        .preview-header {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        background: var(--bg-elevated);
        border-bottom: 1px solid var(--border-default);
        }

        .preview-dots {
        display: flex;
        gap: 6px;
        }

        .preview-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        }

        .preview-dot.red { background: var(--accent-danger); }
        .preview-dot.yellow { background: var(--accent-warning); }
        .preview-dot.green { background: var(--accent-secondary); }

        .preview-title {
        flex: 1;
        font-size: 12px;
        color: var(--text-muted);
        font-weight: 500;
        }

        .preview-frame {
        width: 100%;
        height: calc(100% - 45px);
        border: none;
        background: white;
        }

        .status-message {
        padding: 10px 14px;
        border-radius: var(--radius-md);
        font-size: 12px;
        margin: 12px 0;
        display: none;
        }

        .status-message.show {
        display: block;
        animation: slideIn 0.3s ease-out;
        }

        .status-message.success {
        background: rgba(35, 134, 54, 0.1);
        border: 1px solid rgba(35, 134, 54, 0.3);
        color: var(--accent-secondary);
        }

        .status-message.error {
        background: rgba(248, 81, 73, 0.1);
        border: 1px solid rgba(248, 81, 73, 0.3);
        color: var(--accent-danger);
        }

        @keyframes slideIn {
        from {
        transform: translateY(-10px);
        opacity: 0;
        }
        to {
        transform: translateY(0);
        opacity: 1;
        }
        }

        .tool-view {
        display: none;
        }

        .tool-view.active {
        display: block;
        }

        @media (max-width: 1200px) {
        .main-container {
        grid-template-columns: 1fr;
        gap: 20px;
        }

        .toolbar-stats {
        display: none;
        }
        }

        .hidden { display: none !important; }
        /* Diff styles */
        .diff-hunk { background: rgba(188,140,255,0.08); border-left: 3px solid #bc8cff; padding-left: 8px; }
        .diff-add  { background: rgba(35,134,54,0.12);  border-left: 3px solid #238636; padding-left: 8px; }
        .diff-del  { background: rgba(248,81,73,0.12);  border-left: 3px solid #f85149; padding-left: 8px; }
        .diff-ctx  { background: transparent; padding-left: 8px; opacity: 0.9; }
      </style>
    </head>
    <body>
      <div class="toolbar">
        <div class="toolbar-content">
          <div class="toolbar-brand">
            <div class="brand-icon">CM</div>
              <div class="brand-text">
                <h1>CodeMaster Pro</h1>
                  <div class="brand-subtitle">Code Analysis & Development Hub</div>
                  </div>
                </div>

                <div class="toolbar-nav">
                  <div class="nav-link active" data-tool="main">
                    🏠 CodeMaster Pro
                  </div>
                  <div class="nav-link" data-tool="css">
                    🎨 CSS Standardizer
                  </div>
                  <div class="nav-link" data-tool="prefetch">
                    🔗 Prefetch/Preconnect
                  </div>
                </div>

                <div class="toolbar-stats">
                  <div class="stat-pill" id="lineCount">Lines: 0</div>
                    <div class="stat-pill" id="charCount">Chars: 0</div>
                      <div class="stat-pill" id="changeCount">Changes: 0</div>
                      </div>
                    </div>
                  </div>

                  <div id="mainView" class="tool-view active">
                    <div class="main-container">
                      <div class="panel">
                        <div class="panel-header">
                          <svg class="panel-icon" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                          </svg>
                          <h2 class="panel-title">Code Workshop</h2>
                          </div>

                          <div class="section">
                            <div class="section-title">
                              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6z"/>
                              </svg>
                              Document Templates
                            </div>

                            <div class="template-selector">
                              <div class="template-btn selected" data-template="html5">
                                <div class="template-icon">🌍</div>
                                  <div>HTML5</div>
                                  </div>
                                  <div class="template-btn" data-template="basic">
                                    <div class="template-icon">📄</div>
                                      <div>Basic HTML</div>
                                      </div>
                                      <div class="template-btn" data-template="css">
                                        <div class="template-icon">🎨</div>
                                          <div>CSS</div>
                                          </div>
                                          <div class="template-btn" data-template="js">
                                            <div class="template-icon">⚡</div>
                                              <div>JavaScript</div>
                                              </div>
                                            </div>

                                            <div class="btn-group">
                                              <button class="btn secondary small" id="loadTemplateBtn">📜 Load Template</button>
                                                <button class="btn small" id="clearEditorBtn">🗑️ Clear</button>
                                                </div>
                                              </div>

                                              <div class="section">
                                                <div class="section-title">
                                                  <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                                    <circle cx="11" cy="11" r="8"/>
                                                    <path d="m21 21-4.35-4.35"/>
                                                  </svg>
                                                  Enhanced Search & Focus
                                                </div>

                                                <div class="search-container">
                                                  <input type="text" class="search-input" id="searchInput" placeholder="Search code (multi-line supported)..." autocomplete="off">
                                                  <button class="search-btn" id="searchBtn">
                                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                                      <circle cx="11" cy="11" r="8"/>
                                                      <path d="m21 21-4.35-4.35"/>
                                                    </svg>
                                                  </button>
                                                </div>

                                                <div class="search-results" id="searchResults"></div>

                                                  <div class="status-message" id="searchStatus"></div>
                                                  </div>

                                                  <div class="section">
                                                    <div class="section-title">
                                                      <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                                        <polyline points="7,10 12,15 17,10"/>
                                                        <line x1="12" y1="15" x2="12" y2="3"/>
                                                      </svg>
                                                      File Operations
                                                    </div>

                                                    <div class="upload-area" id="uploadArea">
                                                      <input type="file" id="fileInput" class="file-input" accept=".html,.css,.js,.txt,.htm">
                                                      <div class="upload-icon">📁</div>
                                                        <div class="upload-text">Drop file or click</div>
                                                          <div class="upload-hint">HTML, CSS, JS, TXT files</div>
                                                          </div>

                                                          <div class="btn-group">
                                                            <button class="btn warning small" id="analyzeBtn" disabled>🔍 Analyze File</button>
                                                              <button class="btn primary small" id="saveBtn">💾 Download</button>
                                                                <button class="btn secondary small" id="previewBtn">👁️ Live Preview</button>
                                                                </div>
                                                              </div>

                                                              <div class="section">
                                                                <div class="section-title">
                                                                  <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                                                    <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
                                                                  </svg>
                                                                  Process with Tools
                                                                </div>

                                                                <div class="btn-group" style="flex-direction: column; gap: 6px;">

                                                                  <!-- Built-ins (kept) -->
                                                                  <button class="btn" data-tool-process="css" style="width: 100%;">🎨 CSS Standardizer</button>
                                                                    <button class="btn" data-tool-process="prefetch" style="width: 100%;">🔗 Prefetch Optimizer</button>

                                                                      <!-- NEW: external tool uploader -->
                                                                      <div class="upload-area" id="toolUploadArea" style="margin-top:8px;">
                                                                        <input type="file" id="toolFileInput" class="file-input" accept=".js,.json">
                                                                        <div class="upload-icon">🧩</div>
                                                                          <div class="upload-text">Drop a Tool (.js) or click</div>
                                                                            <div class="upload-hint">Tool must export { name, version, run(code, ctx) }</div>
                                                                            </div>

                                                                            <!-- NEW: installed tools list -->
                                                                            <div id="toolList" style="width:100%; display:flex; flex-direction:column; gap:6px;"></div>
                                                                            </div>
                                                                          </div>
                                                                        </div>

                                                                        <div class="panel">
                                                                          <div class="panel-header">
                                                                            <svg class="panel-icon" viewBox="0 0 24 24" fill="currentColor">
                                                                              <polyline points="16 18 22 12 16 6"/>
                                                                              <polyline points="8 6 2 12 8 18"/>
                                                                            </svg>
                                                                            <h2 class="panel-title">Code Editor & Analysis</h2>
                                                                            </div>

                                                                            <div class="code-editor">
                                                                              <div class="editor-header">
                                                                                <div class="editor-title">Project Code</div>
                                                                                  <div class="editor-controls">
                                                                                    <button class="btn small" id="formatBtn">🎯 Format</button>
                                                                                      <button class="btn small" id="refreshBtn">🔄 Refresh</button>
                                                                                      </div>
                                                                                    </div>
                                                                                    <div class="editor-content">
                                                                                      <div class="line-numbers" id="mainLineNumbers">1</div>
                                                                                        <textarea class="code-textarea" id="mainEditor" placeholder="Start coding here or load a template..."
                                                                                        spellcheck="false" autocomplete="off"></textarea>
                                                                                      </div>
                                                                                    </div>

                                                                                    <div class="code-editor" id="originalSection" style="display: none;">
                                                                                      <div class="editor-header">
                                                                                        <div class="editor-title">Original Code</div>
                                                                                        </div>
                                                                                        <div class="editor-content" style="height: 250px;">
                                                                                          <div class="line-numbers" id="originalLineNumbers">1</div>
                                                                                            <div class="code-display" id="originalCode"></div>
                                                                                            </div>
                                                                                          </div>

                                                                                          <div class="code-editor" id="changesSection" style="display: none;">
                                                                                            <div class="editor-header">
                                                                                              <div class="editor-title">Diff Preview</div>
                                                                                                <div class="editor-controls">
                                                                                                  <button class="btn small" id="showDiffBtn">🧩 Show Diff</button>
                                                                                                    <button class="btn small" id="clearDiffBtn">🧹 Clear</button>
                                                                                                    </div>
                                                                                                  </div>
                                                                                                  <div class="editor-content" style="height: 220px;">
                                                                                                    <div class="line-numbers" id="changesLineNumbers">1</div>
                                                                                                      <pre class="code-display" id="diffOutput" style="white-space: pre-wrap; overflow:auto; margin:0;">// No diff yet</pre>
                                                                                                      </div>
                                                                                                    </div>

                                                                                                    <div class="preview-window">
                                                                                                      <div class="preview-header">
                                                                                                        <div class="preview-dots">
                                                                                                          <div class="preview-dot red"></div>
                                                                                                            <div class="preview-dot yellow"></div>
                                                                                                              <div class="preview-dot green"></div>
                                                                                                              </div>
                                                                                                              <div class="preview-title">Live Preview</div>
                                                                                                                <div class="btn-group">
                                                                                                                  <button class="btn small" id="refreshPreviewBtn">🔄 Refresh</button>
                                                                                                                    <button class="btn small" id="newTabBtn">↗️ New Tab</button>
                                                                                                                    </div>
                                                                                                                  </div>
                                                                                                                  <iframe class="preview-frame" id="previewFrame"
                                                                                                                  sandbox="allow-scripts allow-forms allow-modals allow-popups allow-presentation allow-same-origin"></iframe>
                                                                                                                </div>
                                                                                                              </div>
                                                                                                            </div>
                                                                                                          </div>

                                                                                                          <div id="cssView" class="tool-view">
                                                                                                            <div style="padding: 40px; text-align: center; color: var(--text-muted);">
                                                                                                              <h2>🎨 CSS Standardizer Tool</h2>
                                                                                                                <p>This would embed the CSS Standardizer tool interface</p>
                                                                                                                  <button class="btn primary" data-tool="main" style="margin-top: 20px;">
                                                                                                                    ← Back to CodeMaster Pro
                                                                                                                  </button>
                                                                                                                </div>
                                                                                                              </div>

                                                                                                              <div id="prefetchView" class="tool-view">
                                                                                                                <div style="padding: 40px; text-align: center; color: var(--text-muted);">
                                                                                                                  <h2>🔗 Prefetch/Preconnect Tool</h2>
                                                                                                                    <p>This would embed the Prefetch/Preconnect tool interface</p>
                                                                                                                      <button class="btn primary" data-tool="main" style="margin-top: 20px;">
                                                                                                                        ← Back to CodeMaster Pro
                                                                                                                      </button>
                                                                                                                    </div>
                                                                                                                  </div>

                                                                                                                  <script>
                                                                                                                    // Global state
                                                                                                                    var state = {
                                                                                                                    currentTemplate: 'html5',
                                                                                                                    originalCode: '',
                                                                                                                    currentCode: '',
                                                                                                                    changes: [],
                                                                                                                    searchResults: [],
                                                                                                                    currentFile: null,
                                                                                                                    livePreview: false,
                                                                                                                    installedTools: [], // [{ id, name, version, description, source }],
                                                                                                                    fileLoaded: false
                                                                                                                    };

                                                                                                                    // Code templates - NO SCRIPT TAGS to avoid parsing conflicts
                                                                                                                    var codeTemplates = {
                                                                                                                    html5: '<!DOCTYPE html>\\n<html lang="en">\\n<head>\\n    <meta charset="UTF-8">\\n    <meta name="viewport" content="width=device-width, initial-scale=1.0">\\n    <title>Document</title>\\n    <style>\\n        body {\\n            font-family: Arial, sans-serif;\\n            margin: 0;\\n            padding: 20px;\\n            line-height: 1.6;\\n        }\\n    </style>\\n</head>\\n<body>\\n    <h1>Hello World</h1>\\n    <p>Start building your webpage here...</p>\\n</body>\\n</html>',
                                                                                                                    basic: '<html>\\n<head>\\n    <title>Basic HTML</title>\\n    <style>\\n        body { margin: 20px; }\\n    </style>\\n</head>\\n<body>\\n    <h1>Basic HTML Document</h1>\\n    <p>Simple HTML structure.</p>\\n</body>\\n</html>',
                                                                                                                    css: '/* Stylesheet */\\n:root {\\n    --primary-color: #007bff;\\n    --secondary-color: #6c757d;\\n    --success-color: #28a745;\\n    --danger-color: #dc3545;\\n    --warning-color: #ffc107;\\n    --info-color: #17a2b8;\\n}\\n\\n* {\\n    margin: 0;\\n    padding: 0;\\n    box-sizing: border-box;\\n}\\n\\nbody {\\n    font-family: -apple-system, BlinkMacSystemFont, \\"Segoe UI\\", Roboto, sans-serif;\\n    line-height: 1.6;\\n    color: #333;\\n}\\n\\n.container {\\n    max-width: 1200px;\\n    margin: 0 auto;\\n    padding: 0 20px;\\n}',
                                                                                                                    js: '// JavaScript\\nconsole.log(\"JavaScript is ready!\");\\n\\n// Utility functions\\nconst $ = function(selector) {\\n    return document.querySelector(selector);\\n};\\n\\nconst $$ = function(selector) {\\n    return document.querySelectorAll(selector);\\n};\\n\\n// DOM Ready\\ndocument.addEventListener(\"DOMContentLoaded\", function() {\\n    console.log(\"DOM is ready\");\\n    \\n    // Your code here\\n    \\n});\\n\\n// Example class\\nfunction CodeHelper() {\\n    this.name = \"CodeMaster Pro\";\\n}\\n\\nCodeHelper.prototype.greet = function() {\\n    return \"Hello from \" + this.name + \"!\";\\n};\\n\\nvar helper = new CodeHelper();\\nconsole.log(helper.greet());'
                                                                                                                    };

                                                                                                                    document.addEventListener('DOMContentLoaded', function() {
                                                                                                                    console.log('CodeMaster Pro initialized');
                                                                                                                    setupEventListeners();
                                                                                                                    setupFileUpload();
                                                                                                                    loadTemplate();
                                                                                                                    updateStats();
                                                                                                                    setupToolUploader();
                                                                                                                    renderToolList();

                                                                                                                    // NEW: wire the Diff buttons
                                                                                                                    setupDiffButtons();
                                                                                                                    });

                                                                                                                    // Event listeners setup
                                                                                                                    function setupEventListeners() {
                                                                                                                    // Template selection
                                                                                                                    var templateBtns = document.querySelectorAll('.template-btn');
                                                                                                                    for (var i = 0; i < templateBtns.length; i++) {
                                                                                                                    templateBtns[i].addEventListener('click', function() {
                                                                                                                    selectTemplate(this.getAttribute('data-template'));
                                                                                                                    });
                                                                                                                    }

                                                                                                                    // Buttons
                                                                                                                    document.getElementById('loadTemplateBtn').addEventListener('click', loadTemplate);
                                                                                                                    document.getElementById('clearEditorBtn').addEventListener('click', clearEditor);
                                                                                                                    document.getElementById('searchBtn').addEventListener('click', searchCode);
                                                                                                                    document.getElementById('saveBtn').addEventListener('click', saveFile);
                                                                                                                    document.getElementById('previewBtn').addEventListener('click', toggleLivePreview);
                                                                                                                    document.getElementById('formatBtn').addEventListener('click', formatCode);
                                                                                                                    // Enter to search, Esc to close results
                                                                                                                    var searchInput = document.getElementById('searchInput');
                                                                                                                    if (searchInput) {
                                                                                                                    searchInput.addEventListener('keydown', function (e) {
                                                                                                                    if (e.key === 'Enter') {
                                                                                                                    e.preventDefault();
                                                                                                                    searchCode();
                                                                                                                    } else if (e.key === 'Escape') {
                                                                                                                    clearSearch();
                                                                                                                    this.blur();
                                                                                                                    }
                                                                                                                    });
                                                                                                                    }

                                                                                                                    // Force one-off preview refresh even if live preview is off
                                                                                                                    document.getElementById('refreshBtn').addEventListener('click', function(){ updatePreview(true); });
                                                                                                                    document.getElementById('refreshPreviewBtn').addEventListener('click', function(){ updatePreview(true); });
                                                                                                                    document.getElementById('newTabBtn').addEventListener('click', openInNewTab);

                                                                                                                    // Analyze button
                                                                                                                    document.getElementById('analyzeBtn').addEventListener('click', analyzeLoadedFile);

                                                                                                                    // Editor
                                                                                                                    var editor = document.getElementById('mainEditor');
                                                                                                                    editor.addEventListener('input', handleEditorChange);
                                                                                                                    editor.addEventListener('scroll', function() {
                                                                                                                    syncScroll('main');
                                                                                                                    });

                                                                                                                    // Search
                                                                                                                    var searchInput = document.getElementById('searchInput');
                                                                                                                    searchInput.addEventListener('keydown', function(e) {
                                                                                                                    if (e.key === 'Enter') {
                                                                                                                    searchCode();
                                                                                                                    } else if (e.key === 'Escape') {
                                                                                                                    clearSearch();
                                                                                                                    }
                                                                                                                    });

                                                                                                                    // Navigation
                                                                                                                    var navLinks = document.querySelectorAll('.nav-link');
                                                                                                                    for (var i = 0; i < navLinks.length; i++) {
                                                                                                                    navLinks[i].addEventListener('click', function(e) {
                                                                                                                    var tool = this.getAttribute('data-tool');
                                                                                                                    if (tool === 'css') {
                                                                                                                    e.preventDefault();
                                                                                                                    openWorkshop('css');
                                                                                                                    return;
                                                                                                                    }
                                                                                                                    switchTool(tool);
                                                                                                                    });
                                                                                                                    }

                                                                                                                    // Tool processing
                                                                                                                    var toolBtns = document.querySelectorAll('[data-tool-process]');
                                                                                                                    for (var i = 0; i < toolBtns.length; i++) {
                                                                                                                    toolBtns[i].addEventListener('click', function() {
                                                                                                                    processWithTool(this.getAttribute('data-tool-process'));
                                                                                                                    });
                                                                                                                    }
                                                                                                                    }

                                                                                                                    // Template Management
                                                                                                                    function selectTemplate(templateKey) {
                                                                                                                    state.currentTemplate = templateKey;
                                                                                                                    var templateBtns = document.querySelectorAll('.template-btn');
                                                                                                                    for (var i = 0; i < templateBtns.length; i++) {
                                                                                                                    templateBtns[i].classList.remove('selected');
                                                                                                                    }
                                                                                                                    var selectedBtn = document.querySelector('[data-template="' + templateKey + '"]');
                                                                                                                    if (selectedBtn) selectedBtn.classList.add('selected');
                                                                                                                    showStatus('Selected ' + templateKey.toUpperCase() + ' template', 'success');
                                                                                                                    }

                                                                                                                    function loadTemplate() {
                                                                                                                    var template = codeTemplates[state.currentTemplate];
                                                                                                                    var editor = document.getElementById('mainEditor');
                                                                                                                    if (editor.value.trim() && !confirm('This will replace your current code. Continue?')) return;
                                                                                                                    editor.value = template;
                                                                                                                    state.currentCode = template;
                                                                                                                    state.originalCode = template;
                                                                                                                    updateLineNumbers();
                                                                                                                    updateStats();
                                                                                                                    // No auto-preview unless user enables or presses Refresh
                                                                                                                    showStatus('Loaded ' + state.currentTemplate.toUpperCase() + ' template', 'success');
                                                                                                                    }

                                                                                                                    function clearEditor() {
                                                                                                                    if (confirm('Clear all code? This cannot be undone.')) {
                                                                                                                    var editor = document.getElementById('mainEditor');
                                                                                                                    editor.value = '';
                                                                                                                    state.currentCode = '';
                                                                                                                    state.fileLoaded = false;
                                                                                                                    document.getElementById('analyzeBtn').disabled = true;
                                                                                                                    handleEditorChange();
                                                                                                                    showStatus('Editor cleared', 'success');
                                                                                                                    }
                                                                                                                    }

                                                                                                                    // Editor Management
                                                                                                                    function handleEditorChange() {
                                                                                                                    var editor = document.getElementById('mainEditor');
                                                                                                                    state.currentCode = editor.value;
                                                                                                                    updateLineNumbers();
                                                                                                                    updateStats();
                                                                                                                    if (state.livePreview && isHTMLContent()) {
                                                                                                                    debounce(function(){ updatePreview(true); }, 300)();
                                                                                                                    }
                                                                                                                    }

                                                                                                                    function updateLineNumbers() {
                                                                                                                    var content = state.currentCode;
                                                                                                                    var lineCount = content.split('\n').length;
                                                                                                                    var lineNumbers = document.getElementById('mainLineNumbers');
                                                                                                                    var numbersText = '';
                                                                                                                    for (var i = 1; i <= lineCount; i++) numbersText += i + '\n';
                                                                                                                    lineNumbers.textContent = numbersText;
                                                                                                                    }

                                                                                                                    function syncScroll(windowId) {
                                                                                                                    var textarea = document.getElementById('mainEditor');
                                                                                                                    var lineNumbers = document.getElementById('mainLineNumbers');
                                                                                                                    if (windowId === 'main') lineNumbers.scrollTop = textarea.scrollTop;
                                                                                                                    }

                                                                                                                    // Search Functionality
                                                                                                                    function escapeRegexSpecialChars(str) {
                                                                                                                    return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                                                                                                                    }
                                                                                                                    function clearSearch() {
                                                                                                                    var resultsContainer = document.getElementById('searchResults');
                                                                                                                    if (resultsContainer) {
                                                                                                                    resultsContainer.innerHTML = '';
                                                                                                                    resultsContainer.classList.remove('show');
                                                                                                                    }
                                                                                                                    clearSearchStatus(); // already defined
                                                                                                                    }

                                                                                                                    function searchCode() {
                                                                                                                    var searchTerm = document.getElementById('searchInput').value.trim();
                                                                                                                    var code = state.currentCode;
                                                                                                                    if (!searchTerm) { clearSearch(); return; }

                                                                                                                    try {
                                                                                                                    var searchPattern = searchTerm.replace(/\\n/g, '\n');
                                                                                                                    var lines = code.split('\n');
                                                                                                                    var results = [];
                                                                                                                    var escapedPattern = escapeRegexSpecialChars(searchPattern);
                                                                                                                    var regex = new RegExp(escapedPattern, 'gi');

                                                                                                                    for (var i = 0; i < lines.length; i++) {
                                                                                                                    var line = lines[i];
                                                                                                                    if (regex.test(line)) {
                                                                                                                    regex.lastIndex = 0;
                                                                                                                    var highlightedLine = line.replace(new RegExp(escapedPattern, 'gi'),
                                                                                                                    function(match){ return '<mark>' + escapeHtml(match) + '</mark>'; });
                                                                                                                    results.push({ lineNumber: i + 1, content: line.trim(), fullLine: line, highlightedContent: highlightedLine.trim(), index: i });
                                                                                                                    }
                                                                                                                    }

                                                                                                                    if (searchPattern.includes('\n')) {
                                                                                                                    var multiLineRegex = new RegExp(escapeRegexSpecialChars(searchPattern), 'gi');
                                                                                                                    var match;
                                                                                                                    while ((match = multiLineRegex.exec(code)) !== null) {
                                                                                                                    var beforeMatch = code.substring(0, match.index);
                                                                                                                    var lineNum = (beforeMatch.match(/\n/g) || []).length + 1;
                                                                                                                    var exists = results.some(function(r){ return r.lineNumber === lineNum; });
                                                                                                                    if (!exists) {
                                                                                                                    var matchLines = match[0].split('\n');
                                                                                                                    var displayContent = matchLines[0] + (matchLines.length > 1 ? ' [multiline]' : '');
                                                                                                                    results.push({ lineNumber: lineNum, content: displayContent,
                                                                                                                    highlightedContent: '<mark>' + escapeHtml(displayContent) + '</mark>', index: lineNum - 1 });
                                                                                                                    }
                                                                                                                    }
                                                                                                                    }

                                                                                                                    displaySearchResults(results, searchTerm);
                                                                                                                    } catch (error) {
                                                                                                                    console.error('Search error:', error);
                                                                                                                    showSearchStatus('Search error - please check your search term', 'error');
                                                                                                                    }
                                                                                                                    }

                                                                                                                    function displaySearchResults(results, searchTerm) {
                                                                                                                    var resultsContainer = document.getElementById('searchResults');
                                                                                                                    if (results.length === 0) {
                                                                                                                    resultsContainer.classList.remove('show');
                                                                                                                    showSearchStatus('No matches found for "' + searchTerm + '"', 'error');
                                                                                                                    return;
                                                                                                                    }
                                                                                                                    var html = '';
                                                                                                                    for (var i = 0; i < results.length; i++) {
                                                                                                                    var result = results[i];
                                                                                                                    var displayContent = result.highlightedContent.length > 80 ?
                                                                                                                    result.highlightedContent.substring(0, 80) + '...' : result.highlightedContent;
                                                                                                                    html += '<div class="search-result" data-line="' + result.index + '">'
                                                                                                                    + '<div class="result-line">L' + result.lineNumber + '</div>'
                                                                                                                    + '<div class="result-code">' + displayContent + '</div>'
                                                                                                                    + '<div class="result-actions">'
                                                                                                                    +   '<button class="result-btn" data-action="focus" data-line="' + result.index + '">Focus</button>'
                                                                                                                    +   '<button class="result-btn" data-action="edit" data-line="' + result.index + '">Edit</button>'
                                                                                                                    + '</div>'
                                                                                                                    + '</div>';
                                                                                                                    }
                                                                                                                    resultsContainer.innerHTML = html;
                                                                                                                    resultsContainer.classList.add('show');

                                                                                                                    var resultBtns = resultsContainer.querySelectorAll('.result-btn');
                                                                                                                    for (var i = 0; i < resultBtns.length; i++) {
                                                                                                                    resultBtns[i].addEventListener('click', function(e) {
                                                                                                                    e.stopPropagation();
                                                                                                                    var action = this.getAttribute('data-action');
                                                                                                                    var lineIndex = parseInt(this.getAttribute('data-line'));
                                                                                                                    if (action === 'focus') focusLine(lineIndex);
                                                                                                                    else if (action === 'edit') editLine(lineIndex);
                                                                                                                    });
                                                                                                                    }

                                                                                                                    var resultRows = resultsContainer.querySelectorAll('.search-result');
                                                                                                                    for (var j = 0; j < resultRows.length; j++) {
                                                                                                                    resultRows[j].addEventListener('click', function() {
                                                                                                                    var lineIndex = parseInt(this.getAttribute('data-line'));
                                                                                                                    focusLine(lineIndex);
                                                                                                                    });
                                                                                                                    }
                                                                                                                    showSearchStatus('Found ' + results.length + ' match' + (results.length !== 1 ? 'es' : ''), 'success');
                                                                                                                    }

                                                                                                                    function clearSearch() {
                                                                                                                    document.getElementById('searchInput').value = '';
                                                                                                                    document.getElementById('searchResults').classList.remove('show');
                                                                                                                    clearSearchStatus();
                                                                                                                    }

                                                                                                                    function focusLine(lineIndex) {
                                                                                                                    var editor = document.getElementById('mainEditor');
                                                                                                                    var lineNumbers = document.getElementById('mainLineNumbers');
                                                                                                                    var lines = editor.value.split('\n');
                                                                                                                    var startPos = 0;
                                                                                                                    for (var i = 0; i < lineIndex; i++) startPos += lines[i].length + 1;
                                                                                                                    var endPos = startPos + (lines[lineIndex] ? lines[lineIndex].length : 0);

                                                                                                                    editor.focus();
                                                                                                                    try { editor.setSelectionRange(startPos, endPos); } catch(e) { editor.setSelectionRange(startPos, startPos); }

                                                                                                                    var lineHeight = parseFloat(window.getComputedStyle(editor).lineHeight) || 19.2;
                                                                                                                    var editorRect = editor.getBoundingClientRect();
                                                                                                                    var targetScrollTop = Math.max(0, (lineIndex * lineHeight) - (editorRect.height / 3));
                                                                                                                    editor.scrollTop = targetScrollTop;
                                                                                                                    if (lineNumbers) lineNumbers.scrollTop = targetScrollTop;

                                                                                                                    editor.classList.add('highlight-line');
                                                                                                                    setTimeout(function(){ editor.classList.remove('highlight-line'); }, 2000);
                                                                                                                    showStatus('Focused on line ' + (lineIndex + 1), 'success');
                                                                                                                    }

                                                                                                                    function editLine(lineIndex) {
                                                                                                                    var editor = document.getElementById('mainEditor');
                                                                                                                    var lines = editor.value.split('\n');
                                                                                                                    var currentLine = lines[lineIndex];
                                                                                                                    var newContent = prompt('Edit line ' + (lineIndex + 1) + ':', currentLine);
                                                                                                                    if (newContent !== null && newContent !== currentLine) {
                                                                                                                    lines[lineIndex] = newContent;
                                                                                                                    editor.value = lines.join('\n');
                                                                                                                    state.currentCode = editor.value;
                                                                                                                    state.changes.push({ type: 'edit', line: lineIndex + 1, old: currentLine, new: newContent, timestamp: new Date() });
                                                                                                                    updateLineNumbers();
                                                                                                                    updateStats();
                                                                                                                    updateChangesDisplay();
                                                                                                                    showStatus('Updated line ' + (lineIndex + 1), 'success');
                                                                                                                    setTimeout(function(){ focusLine(lineIndex); }, 100);
                                                                                                                    }
                                                                                                                    }

                                                                                                                    // File Operations
                                                                                                                    function setupFileUpload() {
                                                                                                                    var uploadArea = document.getElementById('uploadArea');
                                                                                                                    var fileInput = document.getElementById('fileInput');

                                                                                                                    uploadArea.addEventListener('click', function() { fileInput.click(); });

                                                                                                                    var events = ['dragenter', 'dragover', 'dragleave', 'drop'];
                                                                                                                    for (var i = 0; i < events.length; i++) {
                                                                                                                    uploadArea.addEventListener(events[i], preventDefaults, false);
                                                                                                                    }
                                                                                                                    function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }

                                                                                                                    var dragEvents = ['dragenter', 'dragover'];
                                                                                                                    for (var j = 0; j < dragEvents.length; j++) {
                                                                                                                    uploadArea.addEventListener(dragEvents[j], function(){ uploadArea.classList.add('dragover'); }, false);
                                                                                                                    }

                                                                                                                    // FIXED: attach listeners to the element, not the string
                                                                                                                    var leaveEvents = ['dragleave', 'drop'];
                                                                                                                    for (var k = 0; k < leaveEvents.length; k++) {
                                                                                                                    uploadArea.addEventListener(leaveEvents[k], function(){ uploadArea.classList.remove('dragover'); }, false);
                                                                                                                    }

                                                                                                                    uploadArea.addEventListener('drop', function(e) {
                                                                                                                    var files = e.dataTransfer.files;
                                                                                                                    if (files && files[0]) handleFile(files[0]);
                                                                                                                    }, false);

                                                                                                                    fileInput.addEventListener('change', function(e) {
                                                                                                                    if (e.target.files && e.target.files[0]) handleFile(e.target.files[0]);
                                                                                                                    });
                                                                                                                    }

                                                                                                                    function handleFile(file) {
                                                                                                                    var validTypes = ['.html', '.css', '.js', '.txt', '.htm'];
                                                                                                                    var fileName = file.name.toLowerCase();
                                                                                                                    var isValid = false;
                                                                                                                    for (var i = 0; i < validTypes.length; i++) {
                                                                                                                    if (fileName.indexOf(validTypes[i]) !== -1) { isValid = true; break; }
                                                                                                                    }
                                                                                                                    if (!isValid) { showStatus('Please select a valid code file', 'error'); return; }

                                                                                                                    var reader = new FileReader();
                                                                                                                    reader.onload = function(e) {
                                                                                                                    try {
                                                                                                                    var content = e.target.result;
                                                                                                                    if (state.currentCode.trim() && !confirm('Replace current code with file content?')) return;
                                                                                                                    var editor = document.getElementById('mainEditor');
                                                                                                                    editor.value = content;
                                                                                                                    state.currentCode = content;
                                                                                                                    state.originalCode = content;
                                                                                                                    state.currentFile = file;
                                                                                                                    state.fileLoaded = true;
                                                                                                                    document.getElementById('analyzeBtn').disabled = false;
                                                                                                                    updateLineNumbers();
                                                                                                                    updateStats();
                                                                                                                    showStatus('File loaded: ' + file.name + ' (Click Analyze to populate workshop)', 'success');
                                                                                                                    } catch (error) {
                                                                                                                    console.error('File load error:', error);
                                                                                                                    showStatus('Error loading file: ' + error.message, 'error');
                                                                                                                    }
                                                                                                                    };
                                                                                                                    reader.onerror = function(){ showStatus('Error reading file', 'error'); };
                                                                                                                    reader.readAsText(file);
                                                                                                                    }

                                                                                                                    function analyzeLoadedFile() {
                                                                                                                    if (!state.fileLoaded || !state.currentFile) { showStatus('No file loaded to analyze', 'error'); return; }
                                                                                                                    try {
                                                                                                                    document.getElementById('originalSection').style.display = 'block';
                                                                                                                    document.getElementById('originalCode').textContent = state.originalCode;
                                                                                                                    updateOriginalLineNumbers();
                                                                                                                    updatePreview(true); // one-off preview
                                                                                                                    updateStats();
                                                                                                                    showStatus('Analyzed ' + state.currentFile.name + ' - Workshop populated', 'success');
                                                                                                                    } catch (error) {
                                                                                                                    console.error('Analysis error:', error);
                                                                                                                    showStatus('Error analyzing file: ' + error.message, 'error');
                                                                                                                    }
                                                                                                                    }

                                                                                                                    // Preview & Export
                                                                                                                    function updatePreview(force) {
                                                                                                                    var code = state.currentCode || '';
                                                                                                                    var iframe = document.getElementById('previewFrame');
                                                                                                                    if (!force && !state.livePreview) return;

                                                                                                                    if (isHTMLContent(code)) {
                                                                                                                    // Use srcdoc to avoid blob churn + flicker
                                                                                                                    iframe.srcdoc = code;
                                                                                                                    } else {
                                                                                                                    var htmlWrapper =
                                                                                                                    '<!DOCTYPE html><html><head><meta charset="utf-8"><title>Code Preview</title>' +
                                                                                                                    '<style>body{font-family:Courier New,monospace;padding:20px;}pre{background:#f5f5f5;padding:15px;border-radius:6px;overflow:auto;}</style>' +
                                                                                                                    '</head><body><h3>Code Content</h3><pre>' + escapeHtml(code) + '</pre></body></html>';
                                                                                                                    iframe.srcdoc = htmlWrapper;
                                                                                                                    }
                                                                                                                    }

                                                                                                                    function toggleLivePreview() {
                                                                                                                    state.livePreview = !state.livePreview;
                                                                                                                    var btn = document.getElementById('previewBtn');
                                                                                                                    if (state.livePreview) {
                                                                                                                    btn.textContent = '⏹️ Stop Preview';
                                                                                                                    updatePreview(true);
                                                                                                                    showStatus('Live preview enabled', 'success');
                                                                                                                    } else {
                                                                                                                    btn.textContent = '👁️ Live Preview';
                                                                                                                    showStatus('Live preview disabled', 'success');
                                                                                                                    }
                                                                                                                    }

                                                                                                                    function openInNewTab() {
                                                                                                                    var code = state.currentCode;
                                                                                                                    if (!code.trim()) { showStatus('No code to preview', 'error'); return; }
                                                                                                                    var blob = new Blob([code], { type: 'text/html' });
                                                                                                                    var url = URL.createObjectURL(blob);
                                                                                                                    window.open(url, '_blank');
                                                                                                                    setTimeout(function(){ URL.revokeObjectURL(url); }, 5000);
                                                                                                                    }

                                                                                                                    function saveFile() {
                                                                                                                    var code = state.currentCode;
                                                                                                                    if (!code.trim()) { showStatus('No code to download', 'error'); return; }

                                                                                                                    var filename = state.currentFile ?
                                                                                                                    state.currentFile.name.replace(/\.[^/.]+$/, '_edited$&') :
                                                                                                                    'codemaster_' + Date.now() + '.html';

                                                                                                                    var mime = isHTMLContent(code) ? 'text/html' : 'text/plain';
                                                                                                                    var blob = new Blob([code], { type: mime });
                                                                                                                    var url = URL.createObjectURL(blob);
                                                                                                                    var a = document.createElement('a');
                                                                                                                    a.href = url;
                                                                                                                    a.download = filename;
                                                                                                                    document.body.appendChild(a);
                                                                                                                    a.click();
                                                                                                                    document.body.removeChild(a);
                                                                                                                    setTimeout(function(){ URL.revokeObjectURL(url); }, 1000);
                                                                                                                    showStatus('Downloaded ' + filename, 'success');
                                                                                                                    }

                                                                                                                    // Tool Navigation
                                                                                                                    function switchTool(toolName) {
                                                                                                                    var navLinks = document.querySelectorAll('.nav-link');
                                                                                                                    for (var i = 0; i < navLinks.length; i++) navLinks[i].classList.remove('active');
                                                                                                                    var activeLink = document.querySelector('[data-tool="' + toolName + '"]');
                                                                                                                    if (activeLink) activeLink.classList.add('active');

                                                                                                                    var views = document.querySelectorAll('.tool-view');
                                                                                                                    for (var j = 0; j < views.length; j++) views[j].classList.remove('active');

                                                                                                                    var viewMap = { 'main': 'mainView', 'css': 'cssView', 'prefetch': 'prefetchView' };
                                                                                                                    var targetView = document.getElementById(viewMap[toolName]);
                                                                                                                    if (targetView) targetView.classList.add('active');
                                                                                                                    }

                                                                                                                    // Tool Processing
                                                                                                                    function processWithTool(toolName) {
                                                                                                                    var code = state.currentCode;
                                                                                                                    if (!code.trim()) { showStatus('No code to process', 'error'); return; }
                                                                                                                    state.originalCode = code;
                                                                                                                    document.getElementById('originalSection').style.display = 'block';
                                                                                                                    document.getElementById('originalCode').textContent = code;
                                                                                                                    updateOriginalLineNumbers();
                                                                                                                    renderUnifiedDiff(state.originalCode || '', state.currentCode || '');
                                                                                                                    showStatus('Processing with ' + toolName + ' tool...', 'success');
                                                                                                                    setTimeout(function(){ showStatus(toolName + ' processing complete', 'success'); }, 1500);
                                                                                                                    }

                                                                                                                    // Changes Tracking
                                                                                                                    function updateChangesDisplay() {
                                                                                                                    if (state.changes.length === 0) return;
                                                                                                                    document.getElementById('changesSection').style.display = 'block';
                                                                                                                    var changesText = '';
                                                                                                                    for (var i = 0; i < state.changes.length; i++) {
                                                                                                                    var change = state.changes[i];
                                                                                                                    changesText += '/* Change ' + (i + 1) + ': ' + change.type + ' on line ' + change.line + ' */\n';
                                                                                                                    changesText += '- ' + change.old + '\n';
                                                                                                                    changesText += '+ ' + change.new + '\n\n';
                                                                                                                    }
                                                                                                                    document.getElementById('changesCode').textContent = changesText;
                                                                                                                    updateChangesLineNumbers();
                                                                                                                    }

                                                                                                                    // ===== Unified Diff (line-based) =====
                                                                                                                    function computeUnifiedDiff(oldStr, newStr, fileA, fileB, contextLines) {
                                                                                                                    var a = oldStr.split('\n');
                                                                                                                    var b = newStr.split('\n');
                                                                                                                    var lcs = buildLCS(a, b);

                                                                                                                    var hunks = [];
                                                                                                                    var i = 0, j = 0, match;
                                                                                                                    var ctx = contextLines || 3;

                                                                                                                    function pushHunk(h) { if (h && (h.added.length || h.removed.length || h.context.length)) hunks.push(h); }

                                                                                                                    while (i < a.length || j < b.length) {
                                                                                                                    match = (i < a.length && j < b.length && lcs[i+1] && lcs[i+1][j+1] === (lcs[i][j] + 1) && a[i] === b[j]);
                                                                                                                    if (match) { i++; j++; continue; }

                                                                                                                    var startA = i, startB = j;
                                                                                                                    var removed = [], added = [], context = [];

                                                                                                                    var trailCtx = [];
                                                                                                                    while (i < a.length || j < b.length) {
                                                                                                                    match = (i < a.length && j < b.length && lcs[i+1] && lcs[i+1][j+1] === (lcs[i][j] + 1) && a[i] === b[j]);
                                                                                                                    if (match) {
                                                                                                                    if (removed.length || added.length) {
                                                                                                                    if (trailCtx.length >= ctx) break;
                                                                                                                    trailCtx.push(a[i]);
                                                                                                                    } else {
                                                                                                                    context.push(a[i]);
                                                                                                                    }
                                                                                                                    i++; j++;
                                                                                                                    } else {
                                                                                                                    if (i < a.length) { removed.push(a[i]); i++; }
                                                                                                                    if (j < b.length) { added.push(b[j]); j++; }
                                                                                                                    trailCtx = [];
                                                                                                                    }
                                                                                                                    }

                                                                                                                    var preCtxStart = Math.max(startA - ctx, 0);
                                                                                                                    var preContext = a.slice(preCtxStart, startA);
                                                                                                                    var postContext = trailCtx;

                                                                                                                    var hunk = {
                                                                                                                    aStart: preCtxStart + 1,
                                                                                                                    aLines: (i - preCtxStart),
                                                                                                                    bStart: Math.max(startB - (startA - preCtxStart), 0) + 1,
                                                                                                                    bLines: (j - Math.max(startB - (startA - preCtxStart), 0)),
                                                                                                                    pre: preContext,
                                                                                                                    removed: removed,
                                                                                                                    added: added,
                                                                                                                    post: postContext
                                                                                                                    };
                                                                                                                    pushHunk(hunk);
                                                                                                                    }

                                                                                                                    var header = '--- ' + (fileA || 'original') + '\n' + '+++ ' + (fileB || 'current') + '\n';
                                                                                                                    var body = hunks.map(function(h) {
                                                                                                                    var s = '@@ -' + h.aStart + ',' + h.aLines + ' +' + h.bStart + ',' + h.bLines + ' @@\n';
                                                                                                                    s += h.pre.map(function(l){ return ' ' + l; }).join('\n');
                                                                                                                    if (h.pre.length) s += '\n';
                                                                                                                    s += h.removed.map(function(l){ return '-' + l; }).join('\n');
                                                                                                                    if (h.removed.length) s += '\n';
                                                                                                                    s += h.added.map(function(l){ return '+' + l; }).join('\n');
                                                                                                                    if (h.added.length) s += '\n';
                                                                                                                    s += h.post.map(function(l){ return ' ' + l; }).join('\n');
                                                                                                                    return s;
                                                                                                                    }).join('\n');
                                                                                                                    return header + body;
                                                                                                                    }

                                                                                                                    function buildLCS(a, b) {
                                                                                                                    var n = a.length, m = b.length;
                                                                                                                    var dp = Array(n+1); for (var i=0;i<=n;i++){ dp[i]=Array(m+1).fill(0); }
                                                                                                                    for (var i=1;i<=n;i++) {
                                                                                                                    for (var j=1;j<=m;j++) {
                                                                                                                    if (a[i-1] === b[j-1]) dp[i][j] = dp[i-1][j-1] + 1;
                                                                                                                    else dp[i][j] = Math.max(dp[i-1][j], dp[i][j-1]);
                                                                                                                    }
                                                                                                                    }
                                                                                                                    return dp;
                                                                                                                    }

                                                                                                                    function renderUnifiedDiff(oldCode, newCode) {
                                                                                                                    var diff = computeUnifiedDiff(
                                                                                                                    oldCode, newCode,
                                                                                                                    (state.currentFile && state.currentFile.name) ? state.currentFile.name + ' (original)' : 'original',
                                                                                                                    (state.currentFile && state.currentFile.name) ? state.currentFile.name + ' (current)' : 'current',
                                                                                                                    3
                                                                                                                    );

                                                                                                                    var outEl = document.getElementById('diffOutput');
                                                                                                                    var lines = diff.split('\n');
                                                                                                                    var html = lines.map(function(line){
                                                                                                                    var cls = 'diff-ctx';
                                                                                                                    if (line.startsWith('@@')) cls = 'diff-hunk';
                                                                                                                    else if (line.startsWith('+') && !line.startsWith('+++')) cls = 'diff-add';
                                                                                                                    else if (line.startsWith('-') && !line.startsWith('---')) cls = 'diff-del';
                                                                                                                    else if (line.startsWith('---') || line.startsWith('+++')) cls = 'diff-hunk';
                                                                                                                    return '<div class="'+cls+'">' + escapeHtml(line) + '</div>';
                                                                                                                    }).join('');
                                                                                                                    outEl.innerHTML = html;

                                                                                                                    document.getElementById('changesSection').style.display = 'block';
                                                                                                                    var total = (diff.match(/\n/g) || []).length + 1;
                                                                                                                    var nums = ''; for (var i=1;i<=total;i++) nums += i + '\n';
                                                                                                                    document.getElementById('changesLineNumbers').textContent = nums;
                                                                                                                    }

                                                                                                                    function setupDiffButtons() {
                                                                                                                    var showBtn = document.getElementById('showDiffBtn');
                                                                                                                    var clearBtn = document.getElementById('clearDiffBtn');
                                                                                                                    if (showBtn) showBtn.addEventListener('click', function(){
                                                                                                                    renderUnifiedDiff(state.originalCode || '', state.currentCode || '');
                                                                                                                    });
                                                                                                                    if (clearBtn) clearBtn.addEventListener('click', function(){
                                                                                                                    var outEl = document.getElementById('diffOutput');
                                                                                                                    if (outEl) outEl.textContent = '// No diff yet';
                                                                                                                    document.getElementById('changesLineNumbers').textContent = '1';
                                                                                                                    });
                                                                                                                    }

                                                                                                                    // Utility Functions
                                                                                                                    function updateStats() {
                                                                                                                    var code = state.currentCode;
                                                                                                                    var lines = code.split('\n').length;
                                                                                                                    var chars = code.length;
                                                                                                                    var changes = state.changes.length;
                                                                                                                    document.getElementById('lineCount').textContent = 'Lines: ' + lines;
                                                                                                                    document.getElementById('charCount').textContent = 'Chars: ' + chars;
                                                                                                                    document.getElementById('changeCount').textContent = 'Changes: ' + changes;
                                                                                                                    }

                                                                                                                    function updateOriginalLineNumbers() {
                                                                                                                    var content = state.originalCode;
                                                                                                                    var lineCount = content.split('\n').length;
                                                                                                                    var lineNumbers = document.getElementById('originalLineNumbers');
                                                                                                                    var numbersText = '';
                                                                                                                    for (var i = 1; i <= lineCount; i++) numbersText += i + '\n';
                                                                                                                    lineNumbers.textContent = numbersText;
                                                                                                                    }

                                                                                                                    function updateChangesLineNumbers() {
                                                                                                                    var content = document.getElementById('changesCode').textContent;
                                                                                                                    var lineCount = content.split('\n').length;
                                                                                                                    var lineNumbers = document.getElementById('changesLineNumbers');
                                                                                                                    var numbersText = '';
                                                                                                                    for (var i = 1; i <= lineCount; i++) numbersText += i + '\n';
                                                                                                                    lineNumbers.textContent = numbersText;
                                                                                                                    }

                                                                                                                    function isHTMLContent(code) {
                                                                                                                    code = (code !== undefined) ? code : state.currentCode || '';
                                                                                                                    return /^\s*<!DOCTYPE/i.test(code) ||
                                                                                                                    /^\s*<html[\s>]/i.test(code) ||
                                                                                                                    /^\s*<head[\s>]/i.test(code) ||
                                                                                                                    /^\s*<body[\s>]/i.test(code);
                                                                                                                    }

                                                                                                                    function formatCode() {
                                                                                                                    var code = state.currentCode || '';
                                                                                                                    if (isHTMLContent(code)) {
                                                                                                                    var formatted = code
                                                                                                                    .replace(/>\s*</g, '>\n<')   // newline only between tags
                                                                                                                    .replace(/\n{3,}/g, '\n\n'); // compress excessive blank lines

                                                                                                                    document.getElementById('mainEditor').value = formatted;
                                                                                                                    state.currentCode = formatted;

                                                                                                                    // keep editor/preview in sync
                                                                                                                    handleEditorChange();

                                                                                                                    // NEW: show unified diff between original and current
                                                                                                                    renderUnifiedDiff(state.originalCode || '', state.currentCode || '');

                                                                                                                    showStatus('HTML formatted (newlines preserved for search/line focus)', 'success');
                                                                                                                    } else {
                                                                                                                    showStatus('Formatter only runs on HTML in this build', 'error');
                                                                                                                    }
                                                                                                                    }

                                                                                                                    function showStatus(message, type) {
                                                                                                                    console.log('[' + type.toUpperCase() + '] ' + message);
                                                                                                                    var notification = document.createElement('div');
                                                                                                                    notification.style.cssText =
                                                                                                                    'position: fixed; top: 20px; right: 20px; padding: 12px 20px; background: ' +
                                                                                                                    (type === 'success' ? '#238636' : '#f85149') +
                                                                                                                    '; color: white; border-radius: 8px; font-size: 13px; z-index: 10000; animation: slideIn 0.3s ease-out;';
                                                                                                                    notification.textContent = message;
                                                                                                                    document.body.appendChild(notification);
                                                                                                                    setTimeout(function() {
                                                                                                                    notification.style.animation = 'slideOut 0.3s ease-in forwards';
                                                                                                                    setTimeout(function() { if (notification.parentNode) notification.parentNode.removeChild(notification); }, 300);
                                                                                                                    }, 3000);
                                                                                                                    }

                                                                                                                    function showSearchStatus(message, type) {
                                                                                                                    var statusEl = document.getElementById('searchStatus');
                                                                                                                    statusEl.textContent = message;
                                                                                                                    statusEl.className = 'status-message show ' + type;
                                                                                                                    }

                                                                                                                    function clearSearchStatus() {
                                                                                                                    var statusEl = document.getElementById('searchStatus');
                                                                                                                    statusEl.classList.remove('show');
                                                                                                                    }

                                                                                                                    function escapeHtml(text) {
                                                                                                                    return text
                                                                                                                    .replace(/&/g, '&amp;')
                                                                                                                    .replace(/</g, '&lt;')
                                                                                                                    .replace(/>/g, '&gt;')
                                                                                                                    .replace(/"/g, '&quot;')
                                                                                                                    .replace(/'/g, '&#039;');
                                                                                                                    }

                                                                                                                    function debounce(func, wait) {
                                                                                                                    var timeout;
                                                                                                                    return function() {
                                                                                                                    var context = this, args = arguments;
                                                                                                                    var later = function() { timeout = null; func.apply(context, args); };
                                                                                                                    clearTimeout(timeout);
                                                                                                                    timeout = setTimeout(later, wait);
                                                                                                                    };
                                                                                                                    }

                                                                                                                    // ============ Tool Uploader / Registry / Runner ============

                                                                                                                    function setupToolUploader() {
                                                                                                                    var area = document.getElementById('toolUploadArea');
                                                                                                                    var input = document.getElementById('toolFileInput');
                                                                                                                    if (!area || !input) return;

                                                                                                                    area.addEventListener('click', function(){ input.click(); });

                                                                                                                    ['dragenter','dragover'].forEach(function(ev){
                                                                                                                    area.addEventListener(ev, function(e){
                                                                                                                    e.preventDefault(); e.stopPropagation();
                                                                                                                    area.classList.add('dragover');
                                                                                                                    });
                                                                                                                    });

                                                                                                                    ['dragleave','drop'].forEach(function(ev){
                                                                                                                    area.addEventListener(ev, function(e){
                                                                                                                    e.preventDefault(); e.stopPropagation();
                                                                                                                    area.classList.remove('dragover');
                                                                                                                    });
                                                                                                                    });

                                                                                                                    area.addEventListener('drop', function(e){
                                                                                                                    var f = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
                                                                                                                    if (f) readToolFile(f);
                                                                                                                    });

                                                                                                                    input.addEventListener('change', function(e){
                                                                                                                    var f = e.target.files && e.target.files[0];
                                                                                                                    if (f) readToolFile(f);
                                                                                                                    e.target.value = '';
                                                                                                                    });
                                                                                                                    }

                                                                                                                    function readToolFile(file) {
                                                                                                                    var ext = (file.name.split('.').pop() || '').toLowerCase();
                                                                                                                    if (!['js','json'].includes(ext)) {
                                                                                                                    showStatus('Unsupported tool type. Please upload .js or .json', 'error');
                                                                                                                    return;
                                                                                                                    }
                                                                                                                    var reader = new FileReader();
                                                                                                                    reader.onload = function(e){
                                                                                                                    var source = String(e.target.result || '');
                                                                                                                    try {
                                                                                                                    var meta = sniffToolMeta(source, file.name);
                                                                                                                    registerTool({
                                                                                                                    id: 'tool_' + Date.now(),
                                                                                                                    name: meta.name,
                                                                                                                    version: meta.version,
                                                                                                                    description: meta.description,
                                                                                                                    source: source
                                                                                                                    });
                                                                                                                    showStatus('Tool installed: ' + meta.name + ' v' + meta.version, 'success');
                                                                                                                    renderToolList();
                                                                                                                    } catch (err) {
                                                                                                                    console.error(err);
                                                                                                                    showStatus('Invalid tool: ' + err.message, 'error');
                                                                                                                    }
                                                                                                                    };
                                                                                                                    reader.onerror = function(){ showStatus('Error reading tool file', 'error'); };
                                                                                                                    reader.readAsText(file);
                                                                                                                    }

                                                                                                                    function sniffToolMeta(source, filename) {
                                                                                                                    var name = (filename || 'Tool').replace(/\.[^.]+$/, '');
                                                                                                                    var version = '1.0.0';
                                                                                                                    var description = 'Custom tool';

                                                                                                                    // Try JSON first
                                                                                                                    try {
                                                                                                                    var obj = JSON.parse(source);
                                                                                                                    if (obj && obj.name && obj.version) {
                                                                                                                    return { name: obj.name, version: obj.version, description: obj.description || '' };
                                                                                                                    }
                                                                                                                    } catch(_){}

                                                                                                                    // Fallback: try to find name/version/description in JS text
                                                                                                                    var mName = source.match(/name\s*:\s*['"]([^'"]+)['"]/);
                                                                                                                    if (mName) name = mName[1];
                                                                                                                    var mVer = source.match(/version\s*:\s*['"]([^'"]+)['"]/);
                                                                                                                    if (mVer) version = mVer[1];
                                                                                                                    var mDesc = source.match(/description\s*:\s*['"]([^'"]+)['"]/);
                                                                                                                    if (mDesc) description = mDesc[1];

                                                                                                                    return { name: name, version: version, description: description };
                                                                                                                    }

                                                                                                                    function registerTool(tool) {
                                                                                                                    var key = (tool.name || '') + '@' + (tool.version || '');
                                                                                                                    var exists = state.installedTools.some(function(t){
                                                                                                                    return (t.name + '@' + t.version) === key;
                                                                                                                    });
                                                                                                                    if (!exists) state.installedTools.push(tool);
                                                                                                                    }

                                                                                                                    function renderToolList() {
                                                                                                                    var el = document.getElementById('toolList');
                                                                                                                    if (!el) return;
                                                                                                                    if (!state.installedTools.length) {
                                                                                                                    el.innerHTML =
                                                                                                                    '<div class="status-message show" style="border:1px solid var(--border-default);">No external tools installed. Upload a .js tool above.</div>';
                                                                                                                    return;
                                                                                                                    }
                                                                                                                    el.innerHTML = state.installedTools.map(function(t, idx){
                                                                                                                    var desc = t.description ? (
                                                                                                                    '<div style="font-size:11px;color:var(--text-muted)">'+escapeHtml(t.description)+'</div>'
                                                                                                                    ) : '';
                                                                                                                    return '' +
                                                                                                                    '<div style="display:flex; align-items:center; justify-content:space-between; gap:8px; border:1px solid var(--border-default); border-radius:8px; padding:8px;">' +
                                                                                                                    '<div>' +
                                                                                                                    '<div style="font-size:13px; font-weight:600;">🧩 ' + escapeHtml(t.name) + ' ' +
                                                                                                                    '<span style="color:var(--text-muted);font-weight:400;">v' + escapeHtml(t.version) + '</span></div>' +
                                                                                                                    desc +
                                                                                                                    '</div>' +
                                                                                                                    '<div class="btn-group">' +
                                                                                                                    '<button class="btn small" data-run-tool="'+idx+'">▶ Run</button>' +
                                                                                                                    '<button class="btn small" data-remove-tool="'+idx+'">🗑 Remove</button>' +
                                                                                                                    '</div>' +
                                                                                                                    '</div>';
                                                                                                                    }).join('');

                                                                                                                    el.querySelectorAll('[data-run-tool]').forEach(function(btn){
                                                                                                                    btn.addEventListener('click', function(){
                                                                                                                    var idx = parseInt(this.getAttribute('data-run-tool'), 10);
                                                                                                                    runToolSandboxed(state.installedTools[idx]);
                                                                                                                    });
                                                                                                                    });
                                                                                                                    el.querySelectorAll('[data-remove-tool]').forEach(function(btn){
                                                                                                                    btn.addEventListener('click', function(){
                                                                                                                    var idx = parseInt(this.getAttribute('data-remove-tool'), 10);
                                                                                                                    state.installedTools.splice(idx, 1);
                                                                                                                    renderToolList();
                                                                                                                    });
                                                                                                                    });
                                                                                                                    }

                                                                                                                    function runToolSandboxed(tool) {
                                                                                                                    var code = state.currentCode || '';
                                                                                                                    if (!code.trim()) { showStatus('No code to process', 'error'); return; }

                                                                                                                    var workerSrc = `
                                                                                                                    self.onmessage = async (e) => {
                                                                                                                    const { source, code, ctx } = e.data;
                                                                                                                    let toolFactory;
                                                                                                                    try {
                                                                                                                    // JSON format
                                                                                                                    if (source.trim().startsWith('{')) {
                                                                                                                    const obj = JSON.parse(source);
                                                                                                                    if (obj && obj.run && typeof obj.run === 'string') {
                                                                                                                    const run = (new Function('return (' + obj.run + ')'))();
                                                                                                                    toolFactory = function(){ return { name: obj.name||'Tool', version: obj.version||'1.0.0', description: obj.description||'', run: run }; };
                                                                                                                    } else {
                                                                                                                    toolFactory = function(){ return { name: obj.name||'Tool', version: obj.version||'1.0.0', description: obj.description||'', run: (c)=>({ code: c, report: 'No-op JSON tool' }) }; };
                                                                                                                    }
                                                                                                                    } else {
                                                                                                                    // JS should return the tool object
                                                                                                                    toolFactory = (new Function(source));
                                                                                                                    }
                                                                                                                    const tool = toolFactory && toolFactory();
                                                                                                                    if (!tool || typeof tool.run !== 'function') throw new Error('Tool does not export a run(code, ctx) function');
                                                                                                                    const result = await tool.run(code, ctx || {});
                                                                                                                    self.postMessage({ ok: true, result });
                                                                                                                    } catch (err) {
                                                                                                                    self.postMessage({ ok: false, error: err.message });
                                                                                                                    }
                                                                                                                    };
                                                                                                                    `;
                                                                                                                    var blob = new Blob([workerSrc], { type: 'text/javascript' });
                                                                                                                    var url = URL.createObjectURL(blob);
                                                                                                                    var worker = new Worker(url);

                                                                                                                    var ctx = { language: detectLanguage(code), filename: (state.currentFile && state.currentFile.name) || 'untitled' };

                                                                                                                    worker.onmessage = function(ev){
                                                                                                                    URL.revokeObjectURL(url);
                                                                                                                    var data = ev.data || {};
                                                                                                                    if (!data.ok) {
                                                                                                                    showStatus('Tool error: ' + (data.error || 'Unknown'), 'error');
                                                                                                                    return;
                                                                                                                    }
                                                                                                                    try {
                                                                                                                    var out = data.result;
                                                                                                                    if (out && typeof out.code === 'string' && out.code !== code) {
                                                                                                                    var old = state.currentCode;
                                                                                                                    state.currentCode = out.code;
                                                                                                                    document.getElementById('mainEditor').value = out.code;

                                                                                                                    // record change
                                                                                                                    state.changes.push({
                                                                                                                    type: 'tool:'+tool.name, line: 0,
                                                                                                                    old: old.split('\n')[0] || '', new: out.code.split('\n')[0] || '',
                                                                                                                    timestamp: new Date()
                                                                                                                    });

                                                                                                                    // keep UI in sync
                                                                                                                    updateLineNumbers();
                                                                                                                    updateStats();
                                                                                                                    if (state.livePreview && isHTMLContent()) updatePreview(true);

                                                                                                                    // show diff immediately
                                                                                                                    renderUnifiedDiff(state.originalCode || '', state.currentCode || '');

                                                                                                                    showStatus('Applied "' + tool.name + '" successfully' + (out.report ? ' — ' + out.report : ''), 'success');
                                                                                                                    } else {
                                                                                                                    showStatus('"' + tool.name + '" completed (no changes made)' + (out && out.report ? ' — ' + out.report : ''), 'success');
                                                                                                                    }
                                                                                                                    } catch (err) {
                                                                                                                    showStatus('Failed applying tool output: ' + err.message, 'error');
                                                                                                                    }
                                                                                                                    };

                                                                                                                    worker.onerror = function(e){
                                                                                                                    URL.revokeObjectURL(url);
                                                                                                                    showStatus('Tool crashed: ' + (e.message || 'Error'), 'error');
                                                                                                                    };

                                                                                                                    worker.postMessage({ source: tool.source, code: code, ctx: ctx });
                                                                                                                    }

                                                                                                                    function detectLanguage(code){
                                                                                                                    if (/^\s*<!DOCTYPE|<html|<head|<body/i.test(code)) return 'html';
                                                                                                                    if (/{\s*[^}]*:\s*[^}]+}/.test(code) && /;?\s*}/.test(code)) return 'css';
                                                                                                                    if (/function\s|\(\)\s*=>|const\s|let\s|var\s/.test(code)) return 'js';
                                                                                                                    return 'text';
                                                                                                                    }
                                                                                                                    /* ===== External Workshop Wiring (CSS Standardizer) ===== */
                                                                                                                    function openWorkshop(tool) {
                                                                                                                    var overlay = document.getElementById('externalWorkshop');
                                                                                                                    var iframe  = document.getElementById('workshopFrame');

                                                                                                                    // Only handle CSS tool here (keeps your existing behavior for others)
                                                                                                                    if (tool !== 'css') {
                                                                                                                    overlay.classList.remove('hidden');
                                                                                                                    iframe.src = 'about:blank';
                                                                                                                    return;
                                                                                                                    }

                                                                                                                    // Show overlay first (prevents white flash)
                                                                                                                    overlay.classList.remove('hidden');

                                                                                                                    // Self-contained CSS editor injected via srcdoc (works inside GHL, no file loads)
                                                                                                                    var html = `
                                                                                                                    <!DOCTYPE html>
                                                                                                                    <html>
                                                                                                                      <head>
                                                                                                                        <meta charset="utf-8">
                                                                                                                        <meta name="viewport" content="width=device-width, initial-scale=1">
                                                                                                                        <title>CSS Editor (Workshop)</title>
                                                                                                                          <style>
                                                                                                                            html,body{height:100%;margin:0;background:#0e1622;color:#e5e7eb;font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
                                                                                                                            .bar{display:flex;align-items:center;gap:8px;padding:10px 12px;background:#0e1622;border-bottom:1px solid #253043}
                                                                                                                            .title{font-size:12px;color:#9aa3ad;text-transform:uppercase;letter-spacing:.5px}
                                                                                                                            .btn{padding:7px 10px;border:1px solid #334155;border-radius:8px;background:#111927;color:#e5e7eb;cursor:pointer}
                                                                                                                            .btn:hover{background:#0f172a}
                                                                                                                            .wrap{height:calc(100% - 44px);display:flex;flex-direction:column;padding:10px}
                                                                                                                            textarea{flex:1;width:100%;resize:none;border:1px solid #334155;border-radius:10px;background:#0b1220;color:#d1d5db;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;padding:12px;outline:none}
                                                                                                                            .hint{margin-top:8px;color:#94a3b8;font-size:12px}
                                                                                                                          </style>
                                                                                                                        </head>
                                                                                                                        <body>
                                                                                                                          <div class="bar">
                                                                                                                            <div class="title">CSS Editor — Workshop</div>
                                                                                                                              <div style="margin-left:auto;display:flex;gap:8px">
                                                                                                                                <button id="btnRequest" class="btn">Request Code</button>
                                                                                                                                  <button id="btnSave" class="btn">Save Back</button>
                                                                                                                                  </div>
                                                                                                                                </div>
                                                                                                                                <div class="wrap">
                                                                                                                                  <textarea id="cssBox" placeholder="Your CSS will appear here..."></textarea>
                                                                                                                                    <div class="hint">Tip: Press Ctrl/Cmd+S to save back to CodeMaster.</div>
                                                                                                                                    </div>

                                                                                                                                    <script>
                                                                                                                                      (function(){
                                                                                                                                      var box = document.getElementById('cssBox');

                                                                                                                                      function pingReady(){
                                                                                                                                      try { parent.postMessage({ type:'WORKSHOP_READY' }, '*'); } catch(_) {}
                                                                                                                                      }

                                                                                                                                      function saveBack(){
                                                                                                                                      try {
                                                                                                                                      parent.postMessage({ type:'WORKSHOP_APPLY_PATCH', content: box.value || '' }, '*');
                                                                                                                                      } catch(e) { console.warn('[child] saveBack error:', e); }
                                                                                                                                      }

                                                                                                                                      function requestCode(){
                                                                                                                                      try { parent.postMessage({ type:'WORKSHOP_REQUEST_CODE' }, '*'); } catch(e) {}
                                                                                                                                      }

                                                                                                                                      window.addEventListener('message', function(ev){
                                                                                                                                      var d = ev && ev.data || {};
                                                                                                                                      if (d.type === 'INJECT_HTML') {
                                                                                                                                      var content = String(d.content || '');
                                                                                                                                      var css = '';
                                                                                                                                      if (/<!DOCTYPE|<html|<head|<body/i.test(content)) {
                                                                                                                                      var match, re = /<style[^>]*>([\\s\\S]*?)<\\/style>/gi;
                                                                                                                                      while ((match = re.exec(content)) !== null) css += (css ? '\\n\\n' : '') + match[1];
                                                                                                                                      } else {
                                                                                                                                      css = content;
                                                                                                                                      }
                                                                                                                                      box.value = css;
                                                                                                                                      }
                                                                                                                                      }, false);

                                                                                                                                      document.getElementById('btnRequest').addEventListener('click', requestCode);
                                                                                                                                      document.getElementById('btnSave').addEventListener('click', saveBack);
                                                                                                                                      window.addEventListener('keydown', function(e){
                                                                                                                                      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's') { e.preventDefault(); saveBack(); }
                                                                                                                                      });

                                                                                                                                      setTimeout(function(){ pingReady(); requestCode(); }, 30);
                                                                                                                                      })();
                                                                                                                                      <\script>
                                                                                                                                    </body>
                                                                                                                                  </html>`.trim();

                                                                                                                                  // Reset and inject
                                                                                                                                  try { iframe.onload = null; } catch(e) {}
                                                                                                                                  iframe.removeAttribute('src');
                                                                                                                                  iframe.srcdoc = html;

                                                                                                                                  // Safety ping in case host mutates the child
                                                                                                                                  setTimeout(function(){
                                                                                                                                  try { iframe.contentWindow && iframe.contentWindow.postMessage({ type:'WORKSHOP_READY' }, '*'); } catch(_) {}
                                                                                                                                  }, 400);
                                                                                                                                  }

                                                                                                                                  function closeWorkshop() {
                                                                                                                                  var overlay = document.getElementById('externalWorkshop');
                                                                                                                                  var iframe  = document.getElementById('workshopFrame');
                                                                                                                                  iframe.src = 'about:blank';
                                                                                                                                  overlay.classList.add('hidden');
                                                                                                                                  }

                                                                                                                                  // Button events
                                                                                                                                  // Delegate so elements can be added later without timing issues
                                                                                                                                  document.addEventListener('click', function(e){
                                                                                                                                  if (e.target.closest('#workshopCloseBtn')) {
                                                                                                                                  e.preventDefault();
                                                                                                                                  closeWorkshop();
                                                                                                                                  return;
                                                                                                                                  }
                                                                                                                                  if (e.target.closest('#workshopSendBtn')) {
                                                                                                                                  e.preventDefault();
                                                                                                                                  var iframe = document.getElementById('workshopFrame');
                                                                                                                                  if (iframe && iframe.contentWindow) {
                                                                                                                                  iframe.contentWindow.postMessage({
                                                                                                                                  type: 'INJECT_HTML',
                                                                                                                                  name: (state.currentFile && state.currentFile.name) ? state.currentFile.name : 'Injected.html',
                                                                                                                                  content: state.currentCode || ''
                                                                                                                                  }, '*');
                                                                                                                                  }
                                                                                                                                  }
                                                                                                                                  });

                                                                                                                                  // Intercept tool process buttons
                                                                                                                                  function processWithTool(tool) {
                                                                                                                                  if (tool === 'css') {
                                                                                                                                  openWorkshop('css');
                                                                                                                                  return;
                                                                                                                                  }
                                                                                                                                  // Fallback for other tools (existing behavior)
                                                                                                                                  switchTool(tool);
                                                                                                                                  }

                                                                                                                                  // Receive messages back from the workshop (apply patch into editor)
                                                                                                                                  window.addEventListener('message', function(e){
                                                                                                                                  var msg = e.data || {};
                                                                                                                                  if (msg.type === 'WORKSHOP_REQUEST_CODE') {
                                                                                                                                  // Tool pulled the trigger to fetch code
                                                                                                                                  var iframe  = document.getElementById('workshopFrame');
                                                                                                                                  iframe.contentWindow.postMessage({
                                                                                                                                  type: 'INJECT_HTML',
                                                                                                                                  name: (state.currentFile && state.currentFile.name) ? state.currentFile.name : 'Injected.html',
                                                                                                                                  content: state.currentCode || ''
                                                                                                                                  }, '*');
                                                                                                                                  } else if (msg.type === 'WORKSHOP_APPLY_PATCH') {
                                                                                                                                  if (msg.content && typeof msg.content === 'string') {
                                                                                                                                  // Apply returned HTML into the editor + update everything
                                                                                                                                  var editor = document.getElementById('mainEditor');
                                                                                                                                  editor.value = msg.content;
                                                                                                                                  state.currentCode = msg.content;
                                                                                                                                  state.fileLoaded = true;
                                                                                                                                  updateLineNumbers();
                                                                                                                                  updateStats();
                                                                                                                                  if (isHTMLContent()) updatePreview(true);
                                                                                                                                  closeWorkshop();
                                                                                                                                  showStatus('Applied CSS update from external workshop', 'success');
                                                                                                                                  } else {
                                                                                                                                  showStatus('Workshop patch missing content', 'error');
                                                                                                                                  }
                                                                                                                                  }
                                                                                                                                  });
                                                                                                                                  /* ===== End External Workshop Wiring ===== */

                                                                                                                                  // Add CSS for animations
                                                                                                                                  var style = document.createElement('style');
                                                                                                                                  style.textContent = '@keyframes slideOut { to { transform: translateX(100%); opacity: 0; } }';
                                                                                                                                  document.head.appendChild(style);
                                                                                                                                </script>

                                                                                                                                <!-- External Workshop Overlay -->
                                                                                                                                <div id="externalWorkshop" class="hidden" style="
                                                                                                                                position: fixed; inset: 0; z-index: 5000;
                                                                                                                                background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center;">
                                                                                                                                <div style="width: 96vw; height: 90vh; max-width: 1600px; border:1px solid #253043; border-radius:12px; overflow:hidden; background:#0e1622; box-shadow:0 30px 120px rgba(0,0,0,.45);">
                                                                                                                                  <div style="display:flex; align-items:center; gap:10px; padding:10px; background:#0e1622; border-bottom:1px solid #253043;">
                                                                                                                                    <div style="font-size:12px; color:#9aa3ad; font-weight:600; text-transform:uppercase; letter-spacing:.5px;">External Workshop</div>
                                                                                                                                      <div style="margin-left:auto; display:flex; gap:8px;">
                                                                                                                                        <button id="workshopSendBtn" class="btn small">📤 Send Code</button>
                                                                                                                                          <button id="workshopCloseBtn" class="btn small">✖ Close</button>
                                                                                                                                          </div>
                                                                                                                                        </div>
                                                                                                                                        <iframe id="workshopFrame" sandbox="allow-scripts allow-forms allow-modals allow-popups allow-presentation allow-same-origin" src="about:blank" style="width:100%; height: calc(100% - 42px); border:0; background:white;"></iframe>
                                                                                                                                        </div>
                                                                                                                                      </div>

                                                                                                                                      <script>
                                                                                                                                        /* ===========================================================
                                                                                                                                        Workshop Bridge (GHL-safe) — CodeMaster parent side
                                                                                                                                        - Push current code to child on READY or REQUEST
                                                                                                                                        - Accept patched CSS back from child and apply to editor/live
                                                                                                                                        =========================================================== */
                                                                                                                                        (function(){
                                                                                                                                        var LOG = '[WorkshopBridge]';
                                                                                                                                        var iframe = document.getElementById('workshopFrame');

                                                                                                                                        // --- Robust getters/setters for CodeMaster editors ---
                                                                                                                                        function getCurrentName(){
                                                                                                                                        try { if (window.state && state.currentFile && state.currentFile.name) return String(state.currentFile.name); } catch(_){}
                                                                                                                                        return 'Injected.html';
                                                                                                                                        }
                                                                                                                                        function getCurrentCode(){
                                                                                                                                        // Prefer your state if present
                                                                                                                                        try { if (window.state && typeof state.currentCode === 'string') return String(state.currentCode); } catch(_){}

                                                                                                                                        // CodeMirror
                                                                                                                                        if (window.editor && typeof window.editor.getValue === 'function') {
                                                                                                                                        try { return String(window.editor.getValue()); } catch(_){}
                                                                                                                                        }
                                                                                                                                        // Ace
                                                                                                                                        if (window.ace && typeof window.ace.edit === 'function') {
                                                                                                                                        try { var inst = window.ace.edit('editor'); if (inst) return String(inst.getValue()); } catch(_){}
                                                                                                                                        }
                                                                                                                                        // Textarea fallbacks
                                                                                                                                        var ta = document.querySelector('textarea[name="code"], textarea#code, textarea[data-role="source"], textarea');
                                                                                                                                        if (ta) return String(ta.value || '');

                                                                                                                                        // As a last resort, push any live CSS in <style id="live-css">
                                                                                                                                        var live = document.querySelector('style#live-css');
                                                                                                                                        if (live && live.textContent) return String(live.textContent);

                                                                                                                                        return '';
                                                                                                                                        }
                                                                                                                                        function applyPatchedCss(css){
                                                                                                                                        // If you maintain a dedicated CSS editor, set it first
                                                                                                                                        if (window.editor && typeof window.editor.setValue === 'function') {
                                                                                                                                        try { window.editor.setValue(css); return; } catch(_){}
                                                                                                                                        }
                                                                                                                                        if (window.ace && typeof window.ace.edit === 'function') {
                                                                                                                                        try { var inst = window.ace.edit('editor'); if (inst) { inst.setValue(css, -1); return; } } catch(_){}
                                                                                                                                        }
                                                                                                                                        var ta = document.querySelector('textarea[name="css"], textarea#css, textarea[data-role="css-source"]');
                                                                                                                                        if (ta) { ta.value = css; return; }

                                                                                                                                        // Live <style> fallback so you can visually verify changes
                                                                                                                                        var live = document.getElementById('live-css');
                                                                                                                                        if (!live) { live = document.createElement('style'); live.id = 'live-css'; document.head.appendChild(live); }
                                                                                                                                        live.textContent = css;
                                                                                                                                        }

                                                                                                                                        // --- Push helper ---
                                                                                                                                        function pushToChild(){
                                                                                                                                        if (!iframe || !iframe.contentWindow) return;
                                                                                                                                        var name = getCurrentName();
                                                                                                                                        var content = getCurrentCode();
                                                                                                                                        try {
                                                                                                                                        iframe.contentWindow.postMessage({ type:'INJECT_HTML', name: name, content: content }, '*');
                                                                                                                                        console.log(LOG, 'Pushed code to child:', { name, bytes: (content||'').length });
                                                                                                                                        } catch (e) { console.warn(LOG, 'pushToChild error:', e); }
                                                                                                                                        }

                                                                                                                                        // --- Listener for workshop events ---
                                                                                                                                        window.addEventListener('message', function(e){
                                                                                                                                        var msg = e && e.data || {};
                                                                                                                                        if (!msg || typeof msg !== 'object') return;

                                                                                                                                        if (msg.type === 'WORKSHOP_READY') {
                                                                                                                                        // Child is ready → immediately send current code
                                                                                                                                        pushToChild();
                                                                                                                                        } else if (msg.type === 'WORKSHOP_REQUEST_CODE') {
                                                                                                                                        // Child explicitly asked → send current code
                                                                                                                                        pushToChild();
                                                                                                                                        } else if (msg.type === 'WORKSHOP_APPLY_PATCH') {
                                                                                                                                        // Child returned patched CSS (string)
                                                                                                                                        var css = String(msg.content || '');
                                                                                                                                        console.log(LOG, 'Received patched CSS:', { bytes: css.length });
                                                                                                                                        applyPatchedCss(css);
                                                                                                                                        // Optional: close overlay here if you want auto-close after save
                                                                                                                                        // var overlay = document.getElementById('externalWorkshop');
                                                                                                                                        // if (overlay) overlay.classList.add('hidden');
                                                                                                                                        }
                                                                                                                                        }, false);

                                                                                                                                        })();
                                                                                                                                      </script>
                                                                                                                                      <script>
                                                                                                                                        /* ===========================================================
                                                                                                                                        Workshop Bridge — CodeMaster parent side (GHL-safe)
                                                                                                                                        - Sends current code to the overlay when it reports READY or requests code
                                                                                                                                        - Applies patched CSS that the overlay sends back
                                                                                                                                        =========================================================== */
                                                                                                                                        (function(){
                                                                                                                                        var LOG = '[WorkshopBridge]';
                                                                                                                                        var iframe = document.getElementById('workshopFrame');

                                                                                                                                        // ---- Where your current code lives (robust fallbacks) ----
                                                                                                                                        function getCurrentName(){
                                                                                                                                        try { if (window.state && state.currentFile && state.currentFile.name) return String(state.currentFile.name); } catch(_){}
                                                                                                                                        return 'Injected.html';
                                                                                                                                        }

                                                                                                                                        function getCurrentCode(){
                                                                                                                                        // 1) Project state (if you maintain it)
                                                                                                                                        try { if (window.state && typeof state.currentCode === 'string') return String(state.currentCode); } catch(_){}

                                                                                                                                        // 2) CodeMirror
                                                                                                                                        if (window.editor && typeof window.editor.getValue === 'function') {
                                                                                                                                        try { return String(window.editor.getValue()); } catch(_){}
                                                                                                                                        }

                                                                                                                                        // 3) Ace (common id='editor')
                                                                                                                                        if (window.ace && typeof window.ace.edit === 'function') {
                                                                                                                                        try { var inst = window.ace.edit('editor'); if (inst) return String(inst.getValue()); } catch(_){}
                                                                                                                                        }

                                                                                                                                        // 4) Textarea/common
                                                                                                                                        var ta = document.querySelector('textarea[name="code"], textarea#code, textarea[data-role="source"]');
                                                                                                                                        if (ta) return String(ta.value || '');

                                                                                                                                        // 5) LAST RESORT: scrape the main rendered code container (CodeMaster UI)
                                                                                                                                        //    Use your actual container class here; .editor-content is common in your project.
                                                                                                                                        var pre = document.querySelector('.editor-content, pre.code, pre, code');
                                                                                                                                        if (pre) return String(pre.textContent || '');

                                                                                                                                        return '';
                                                                                                                                        }

                                                                                                                                        function applyPatchedCss(css){
                                                                                                                                        // Update a dedicated CSS buffer/editor if present
                                                                                                                                        if (window.editor && typeof window.editor.setValue === 'function') {
                                                                                                                                        try { window.editor.setValue(css); return; } catch(_){}
                                                                                                                                        }
                                                                                                                                        if (window.ace && typeof window.ace.edit === 'function') {
                                                                                                                                        try { var inst = window.ace.edit('editor'); if (inst) { inst.setValue(css, -1); return; } } catch(_){}
                                                                                                                                        }
                                                                                                                                        var ta = document.querySelector('textarea[name="css"], textarea#css, textarea[data-role="css-source"]');
                                                                                                                                        if (ta) { ta.value = css; return; }

                                                                                                                                        // Live <style> fallback for immediate visual verification
                                                                                                                                        var live = document.getElementById('live-css');
                                                                                                                                        if (!live) { live = document.createElement('style'); live.id = 'live-css'; document.head.appendChild(live); }
                                                                                                                                        live.textContent = css;
                                                                                                                                        }

                                                                                                                                        // ---- Push helper ----
                                                                                                                                        function pushToChild(){
                                                                                                                                        if (!iframe || !iframe.contentWindow) return;
                                                                                                                                        var name = getCurrentName();
                                                                                                                                        var content = getCurrentCode();
                                                                                                                                        try {
                                                                                                                                        iframe.contentWindow.postMessage({ type:'INJECT_HTML', name: name, content: content }, '*');
                                                                                                                                        console.log(LOG, 'Pushed code to child:', { name, bytes: (content||'').length });
                                                                                                                                        } catch (e) { console.warn(LOG, 'pushToChild error:', e); }
                                                                                                                                        }

                                                                                                                                        // ---- Message Listener ----
                                                                                                                                        window.addEventListener('message', function(e){
                                                                                                                                        var msg = e && e.data || {};
                                                                                                                                        if (!msg || typeof msg !== 'object') return;

                                                                                                                                        if (msg.type === 'WORKSHOP_READY') {
                                                                                                                                        // Child is ready → immediately send current code
                                                                                                                                        pushToChild();
                                                                                                                                        } else if (msg.type === 'WORKSHOP_REQUEST_CODE') {
                                                                                                                                        // Child explicitly asked → send again
                                                                                                                                        pushToChild();
                                                                                                                                        } else if (msg.type === 'WORKSHOP_APPLY_PATCH') {
                                                                                                                                        // Child returned patched CSS (string)
                                                                                                                                        var css = String(msg.content || '');
                                                                                                                                        console.log(LOG, 'Received patched CSS:', { bytes: css.length });
                                                                                                                                        applyPatchedCss(css);
                                                                                                                                        // Optional: auto-close overlay after save
                                                                                                                                        // var overlay = document.getElementById('externalWorkshop');
                                                                                                                                        // if (overlay) overlay.classList.add('hidden');
                                                                                                                                        }
                                                                                                                                        }, false);

                                                                                                                                        })();
                                                                                                                                      </script>
                                                                                                                                    </body>

                                                                                                                                  </html>