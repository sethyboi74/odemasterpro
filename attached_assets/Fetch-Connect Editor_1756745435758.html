<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>CodeMaster ‚Äî Prefetch / Preconnect Inspector</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
  @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&display=swap');
  
  :root{
    --bg1:#0a0b0f;--bg2:#0f1419;--bg3:#161b22;--elev:#21262d;
    --txt:#f0f6fc;--muted:#9aa3ad;--muter:#7d8590;
    --pri:#58a6ff;--ok:#238636;--warn:#d29922;--err:#f85149;--pur:#bc8cff;--teal:#39d0d8;
    --bd:#30363d;--bdm:#21262d;--mono:'JetBrains Mono','Fira Code',Consolas,monospace;
  }
  
  *{box-sizing:border-box;margin:0;padding:0}
  body{background:linear-gradient(135deg,#0a0b0f,#1a1b23);color:var(--txt);font-family:Inter,system-ui,-apple-system,sans-serif;line-height:1.5}
  
  .header{background:linear-gradient(135deg,rgba(88,166,255,.08),rgba(188,140,255,.08));border-bottom:1px solid var(--bd);padding:20px;position:sticky;top:0;z-index:5}
  .header-inner{max-width:1400px;margin:0 auto;display:flex;align-items:center;justify-content:space-between}
  .header h1{font-size:22px;background:linear-gradient(135deg,var(--pri),var(--pur));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
  .stats{display:flex;gap:10px}
  .pill{background:rgba(255,255,255,.04);border:1px solid var(--bdm);border-radius:10px;padding:6px 10px;font-size:12px}

  .main{max-width:1400px;margin:0 auto;padding:24px;display:grid;grid-template-columns:380px 1fr;gap:24px;min-height:calc(100vh - 120px)}
  .panel{background:linear-gradient(145deg,var(--bg2),var(--bg3));border:1px solid var(--bd);border-radius:16px;padding:16px;box-shadow:0 8px 28px rgba(0,0,0,.25);display:flex;flex-direction:column;gap:14px;overflow-y:auto}
  .panel.left{max-height:calc(100vh - 160px)}
  .panel h2{font-size:16px;font-weight:600}
  
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .btn{display:inline-flex;gap:8px;align-items:center;justify-content:center;border:1px solid var(--bd);border-radius:10px;background:var(--elev);color:var(--txt);font-size:13px;font-weight:500;padding:8px 12px;cursor:pointer;transition:all 0.2s;text-decoration:none}
  .btn:hover:not(:disabled){transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,0.15)}
  .btn.primary{background:linear-gradient(135deg,var(--pri),var(--pur));border-color:transparent;color:white}
  .btn.ok{background:linear-gradient(135deg,var(--ok),var(--teal));border-color:transparent;color:white}
  .btn.warn{background:linear-gradient(135deg,var(--warn),#f59e0b);border-color:transparent;color:white}
  .btn:disabled{opacity:.55;cursor:not-allowed;transform:none}
  
  .upload{border:2px dashed var(--bd);border-radius:12px;padding:20px;text-align:center;cursor:pointer;background:linear-gradient(145deg,rgba(88,166,255,.04),rgba(188,140,255,.04));transition:all 0.3s ease;position:relative}
  .upload:hover{border-color:var(--pri);background:linear-gradient(145deg,rgba(88,166,255,.08),rgba(188,140,255,.08));transform:translateY(-2px)}
  .upload.drag{border-color:var(--teal);background:linear-gradient(145deg,rgba(57,208,216,.1),rgba(88,166,255,.1));transform:scale(1.02)}
  .upload-icon{font-size:24px;margin-bottom:8px}
  .meta{font-size:12px;color:var(--muter)}

  .list{display:flex;flex-direction:column;gap:8px;max-height:200px;overflow-y:auto}
  .item{border:1px solid var(--bdm);background:rgba(255,255,255,.03);border-radius:12px;padding:12px;display:grid;grid-template-columns:1fr 180px;align-items:center;gap:8px;transition:all 0.2s}
  .item:hover{background:rgba(255,255,255,.06);transform:translateY(-1px)}
  .item .chips{display:flex;gap:6px;flex-wrap:wrap}
  .chip{background:#17212b;border:1px solid var(--bdm);border-radius:999px;padding:4px 8px;font-size:12px;color:#c8d2de}
  .btns{display:flex;gap:6px;justify-content:flex-end;min-width:180px}

  .win{background:#0b1320;border:1px solid #1c2740;border-radius:12px;overflow:hidden;margin-bottom:16px}
  .win-head{display:flex;align-items:center;gap:10px;padding:10px;background:#0e1622;border-bottom:1px solid #1c2740}
  .win-head .title{font-size:12px;color:#9aa3ad;font-weight:600;text-transform:uppercase;letter-spacing:0.5px}
  .win-body{display:flex;height:200px}
  .win.tall .win-body{height:280px}
  
  .gut{width:56px;background:#0b1320;border-right:1px solid #1c2740;color:#7c8aa8;font-family:var(--mono);font-size:12px;padding:8px 6px;overflow:auto;text-align:right;user-select:none;line-height:1.4}
  .code{flex:1;background:#0b1320;color:#cfe1ff;font-family:var(--mono);font-size:12px;padding:8px 10px;white-space:pre;overflow:auto;line-height:1.4;border:0;resize:none;outline:none}
  .code:focus{background:#0d1521}
  
  .hi{background:#243149 !important;outline:2px solid #3b82f6;box-shadow:0 0 0 2px rgba(59,130,246,.5) inset}
  
  .legend{margin-left:auto;display:flex;gap:8px}
  .flag{padding:2px 6px;border-radius:6px;border:1px solid var(--bdm);font-size:11px}
  .flag.add{background:rgba(35,134,54,.15);border-color:rgba(35,134,54,.3);color:#4ade80}
  .flag.del{background:rgba(248,81,73,.12);border-color:rgba(248,81,73,.35);color:#f87171}
  .flag.mod{background:rgba(210,153,34,.15);border-color:rgba(210,153,34,.35);color:#fbbf24}

  .preview{background:#0b1320;border:1px solid #1c2740;border-radius:12px;height:280px;overflow:hidden}
  .preview-head{display:flex;gap:10px;align-items:center;padding:10px;background:#0e1622;border-bottom:1px solid #1c2740}
  .dot{width:12px;height:12px;border-radius:50%}.dot.r{background:#f85149}.dot.y{background:#d29922}.dot.g{background:#238636}
  .preview iframe{width:100%;height:calc(100% - 44px);border:0;background:#fff}

  .hidden{display:none}
  
  .success{background:rgba(35,134,54,.1);border:1px solid rgba(35,134,54,.3);color:#4ade80;padding:8px;border-radius:8px;font-size:12px;margin:8px 0}
  .debug{background:rgba(248,81,73,.1);border:1px solid rgba(248,81,73,.3);color:#f87171;padding:8px;border-radius:8px;font-size:12px;margin:8px 0}
  
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center;z-index:1000}
  .modal{width:560px;max-width:95vw;background:#0e1622;border:1px solid #253043;border-radius:12px;box-shadow:0 30px 120px rgba(0,0,0,.45);padding:20px}
  .field{margin:12px 0}
  .field-label{font-size:12px;color:var(--muted);margin-bottom:4px;font-weight:500}
  .field input, .field select{width:100%;background:var(--elev);border:1px solid var(--bd);border-radius:8px;padding:10px;color:var(--txt);font-size:13px}
  .field input:focus, .field select:focus{outline:none;border-color:var(--pri)}
</style>
</head>
<body>
  <div class="header">
    <div class="header-inner">
      <h1>üîó Prefetch / Preconnect Inspector</h1>
      <div class="stats">
        <span class="pill" id="count">Found: 0</span>
        <span class="pill" id="kinds">0 preconnect ‚Ä¢ 0 dns-prefetch ‚Ä¢ 0 prefetch ‚Ä¢ 0 preload</span>
      </div>
    </div>
  </div>

  <div class="main">
    <section class="panel left">
      <h2>üìÅ Load & Analyze</h2>
      <div class="upload" id="dropZone">
        <div class="upload-icon">üìÑ</div>
        <div style="font-weight:600;margin-bottom:4px">Drop HTML file here or click to browse</div>
        <div class="meta">We'll analyze and extract your preconnect/prefetch/preload tags</div>
        <input type="file" id="fileInput" accept=".html,.htm" style="display:none">
      </div>
      
      <div class="row">
        <button class="btn primary" id="analyzeBtn" disabled>
          üîç Analyze File
        </button>
        <button class="btn ok" id="applyBtn" disabled>
          ‚úÖ Apply Changes
        </button>
        <button class="btn warn" id="resetBtn" disabled>
          üîÑ Reset All
        </button>
      </div>
      
      <div id="statusMessage" class="hidden"></div>

      <div id="hintsSection" class="hidden">
        <h2>üéØ Detected Hints</h2>
        <div class="list" id="hintsList">
          <div class="meta">No prefetch/preconnect hints found yet.</div>
        </div>
        <div class="row" style="justify-content:flex-end;margin-top:8px">
          <button class="btn" id="addHintBtn">‚ûï Add New Hint</button>
        </div>
      </div>
      
      <label class="row" style="gap:6px;font-size:12px;margin-top:12px">
        <input type="checkbox" id="autoApply" checked> 
        <span>Auto-apply changes when editing</span>
      </label>
    </section>

    <section class="panel">
      <h2>üíª Code Analysis & Preview</h2>

      <div class="win">
        <div class="win-head">
          <span class="title">üéØ Prefetch/Preconnect Matches</span>
        </div>
        <div class="win-body">
          <div class="gut" id="matchesGutter"></div>
          <div class="code" id="matchesCode">// Upload and analyze HTML to see extracted hints here</div>
        </div>
      </div>

      <div class="win">
        <div class="win-head">
          <span class="title">üìù Full Lines (click Focus to highlight)</span>
        </div>
        <div class="win-body">
          <div class="gut" id="linesGutter"></div>
          <div class="code" id="linesCode">// Complete lines containing hints will appear here</div>
        </div>
      </div>

      <div class="win tall">
        <div class="win-head">
          <span class="title">üìÑ Original Document</span>
        </div>
        <div class="win-body">
          <div class="gut" id="originalGutter"></div>
          <div class="code" id="originalCode">// Your original HTML document will appear here</div>
        </div>
      </div>

      <div class="win tall">
        <div class="win-head">
          <span class="title">‚úèÔ∏è Edited Document (Live Updates)</span>
          <div class="legend">
            <span class="flag add">added</span>
            <span class="flag mod">modified</span>
            <span class="flag del">removed</span>
          </div>
        </div>
        <div class="win-body">
          <div class="gut" id="editedGutter"></div>
          <div class="code" id="editedCode">// Edited version with your changes will appear here</div>
        </div>
      </div>

      <div class="win">
        <div class="win-head">
          <span class="title">üìä Changes Summary</span>
        </div>
        <div class="win-body">
          <div class="gut" id="changesGutter"></div>
          <div class="code" id="changesCode">// Summary of all changes made will appear here</div>
        </div>
      </div>

      <div class="preview">
        <div class="preview-head">
          <div class="dot r"></div><div class="dot y"></div><div class="dot g"></div>
          <div class="meta" style="margin-left:8px">HTML Preview</div>
          <div class="row" style="margin-left:auto;gap:8px">
            <button class="btn" id="previewOrigBtn">üëÅÔ∏è Original</button>
            <button class="btn" id="previewEditedBtn">üëÅÔ∏è Edited</button>
            <button class="btn primary" id="downloadEditedBtn" disabled>üíæ Download Edited</button>
            <button class="btn" id="downloadOrigBtn" disabled>üíæ Download Original</button>
          </div>
        </div>
        <iframe id="previewFrame" sandbox="allow-scripts allow-forms allow-modals allow-popups allow-presentation allow-same-origin" src="about:blank"></iframe>
      </div>
    </section>
  </div>

  <div id="modalContainer" class="hidden"></div>

<script>
// Global state
let state = {
  originalHTML: '',
  editedHTML: '',
  filename: '',
  hints: [],
  originalHints: [],
  isAnalyzed: false
};

// Utility functions
function showMessage(text, type = 'success') {
  const statusEl = document.getElementById('statusMessage');
  statusEl.className = type;
  statusEl.textContent = text;
  statusEl.classList.remove('hidden');
  setTimeout(() => statusEl.classList.add('hidden'), 4000);
}

function updateGutter(gutterId, text) {
  const lines = text.split('\n').length;
  let gutterText = '';
  for (let i = 1; i <= lines; i++) {
    gutterText += String(i).padStart(4, ' ') + '\n';
  }
  document.getElementById(gutterId).textContent = gutterText;
}

function setCodeWindow(codeId, gutterId, content) {
  const codeEl = document.getElementById(codeId);
  const gutterEl = document.getElementById(gutterId);
  codeEl.textContent = content;
  updateGutter(gutterId, content);
}

function escapeHtml(text) {
  return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

function createBlobUrl(content, type = 'text/html') {
  const blob = new Blob([content], { type });
  return URL.createObjectURL(blob);
}

function downloadFile(filename, content) {
  const url = createBlobUrl(content);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  setTimeout(() => URL.revokeObjectURL(url), 1000);
}

// File handling
function setupFileUpload() {
  const dropZone = document.getElementById('dropZone');
  const fileInput = document.getElementById('fileInput');

  // Click to browse
  dropZone.addEventListener('click', () => {
    fileInput.click();
  });

  // File input change
  fileInput.addEventListener('change', (e) => {
    if (e.target.files && e.target.files[0]) {
      handleFile(e.target.files[0]);
    }
  });

  // Prevent default drag behaviors
  ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    document.addEventListener(eventName, preventDefaults, false);
    dropZone.addEventListener(eventName, preventDefaults, false);
  });

  function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
  }

  // Highlight drop zone when item is dragged over it
  ['dragenter', 'dragover'].forEach(eventName => {
    dropZone.addEventListener(eventName, () => {
      dropZone.classList.add('drag');
    }, false);
  });

  ['dragleave', 'drop'].forEach(eventName => {
    dropZone.addEventListener(eventName, () => {
      dropZone.classList.remove('drag');
    }, false);
  });

  // Handle dropped files
  dropZone.addEventListener('drop', (e) => {
    const dt = e.dataTransfer;
    const files = dt.files;
    if (files && files[0]) {
      handleFile(files[0]);
    }
  }, false);
}

function handleFile(file) {
  // Validate file type
  if (!file.name.toLowerCase().endsWith('.html') && !file.name.toLowerCase().endsWith('.htm')) {
    showMessage('Please select an HTML file (.html or .htm)', 'debug');
    return;
  }

  const reader = new FileReader();
  
  reader.onload = function(e) {
    try {
      const content = e.target.result;
      
      if (!content || content.trim().length === 0) {
        showMessage('The file appears to be empty', 'debug');
        return;
      }

      // Store the file data
      state.originalHTML = content;
      state.editedHTML = content;
      state.filename = file.name;
      state.isAnalyzed = false;
      state.hints = [];

      // Update UI
      setCodeWindow('originalCode', 'originalGutter', state.originalHTML);
      setCodeWindow('editedCode', 'editedGutter', state.editedHTML);
      setCodeWindow('matchesCode', 'matchesGutter', '// Click "Analyze File" to extract hints');
      setCodeWindow('linesCode', 'linesGutter', '// Lines with hints will appear here after analysis');
      setCodeWindow('changesCode', 'changesGutter', '// Changes will be tracked here');

      // Enable buttons
      document.getElementById('analyzeBtn').disabled = false;
      document.getElementById('resetBtn').disabled = false;
      document.getElementById('downloadOrigBtn').disabled = false;

      // Update preview
      updatePreview(state.originalHTML);

      showMessage(`Loaded ${file.name} (${Math.round(content.length / 1024)}KB)`, 'success');
      
    } catch (error) {
      console.error('Error loading file:', error);
      showMessage('Error loading file: ' + error.message, 'debug');
    }
  };

  reader.onerror = function() {
    showMessage('Error reading file', 'debug');
  };

  reader.readAsText(file);
}

// Analysis functions
function analyzeHTML() {
  if (!state.originalHTML) {
    showMessage('No HTML file loaded', 'debug');
    return;
  }

  const analyzeBtn = document.getElementById('analyzeBtn');
  analyzeBtn.disabled = true;
  analyzeBtn.textContent = 'üîç Analyzing...';

  try {
    // Extract prefetch/preconnect hints
    state.hints = extractHints(state.originalHTML);
    state.originalHints = state.hints.map(hint => ({ ...hint }));
    state.isAnalyzed = true;

    // Update displays
    displayHints();
    updateMatchesWindow();
    updateLinesWindow();
    updateCounters();

    // Enable editing
    document.getElementById('applyBtn').disabled = state.hints.length === 0;
    document.getElementById('downloadEditedBtn').disabled = false;

    // Show hints section
    document.getElementById('hintsSection').classList.remove('hidden');

    if (state.hints.length > 0) {
      showMessage(`Found ${state.hints.length} prefetch/preconnect hints!`, 'success');
    } else {
      showMessage('No prefetch/preconnect hints found in this HTML file', 'debug');
    }

  } catch (error) {
    console.error('Analysis error:', error);
    showMessage('Analysis failed: ' + error.message, 'debug');
  }

  analyzeBtn.disabled = false;
  analyzeBtn.textContent = 'üîç Re-analyze';
}

function extractHints(html) {
  const hints = [];
  const lines = html.split('\n');
  
  // Regex to match link tags with prefetch/preconnect rel values
  const linkRegex = /<link\s+[^>]*>/gi;
  let match;

  while ((match = linkRegex.exec(html)) !== null) {
    const linkTag = match[0];
    const parsed = parseLinkTag(linkTag);
    
    if (isResourceHint(parsed.rel)) {
      const lineNumber = getLineNumber(html, match.index);
      hints.push({
        ...parsed,
        raw: linkTag,
        line: lineNumber,
        lineText: lines[lineNumber - 1] || '',
        startIndex: match.index,
        endIndex: match.index + linkTag.length
      });
    }
  }

  return hints.sort((a, b) => a.line - b.line);
}

function parseLinkTag(tag) {
  const getAttribute = (name) => {
    // Try quoted attributes first
    const quotedRegex = new RegExp(`\\b${name}\\s*=\\s*["']([^"']*?)["']`, 'i');
    const quotedMatch = tag.match(quotedRegex);
    if (quotedMatch) return quotedMatch[1];

    // Try unquoted attributes
    const unquotedRegex = new RegExp(`\\b${name}\\s*=\\s*([^\\s>]+)`, 'i');
    const unquotedMatch = tag.match(unquotedRegex);
    if (unquotedMatch) return unquotedMatch[1];

    return '';
  };

  return {
    rel: getAttribute('rel'),
    href: getAttribute('href'),
    as: getAttribute('as'),
    crossorigin: /\bcrossorigin\b/i.test(tag)
  };
}

function isResourceHint(rel) {
  if (!rel) return false;
  const hintTypes = ['preconnect', 'dns-prefetch', 'prefetch', 'preload'];
  const relTokens = rel.toLowerCase().split(/\s+/);
  return hintTypes.some(type => relTokens.includes(type));
}

function getLineNumber(text, index) {
  return text.substring(0, index).split('\n').length;
}

// Display functions
function displayHints() {
  const container = document.getElementById('hintsList');
  
  if (state.hints.length === 0) {
    container.innerHTML = '<div class="meta">No prefetch/preconnect hints found.</div>';
    return;
  }

  container.innerHTML = state.hints.map((hint, index) => `
    <div class="item">
      <div class="chips">
        <span class="chip" style="background: ${getHintColor(hint.rel)}; border-color: ${getHintColor(hint.rel)}66">
          #${index + 1} ‚Ä¢ Line ${hint.line}
        </span>
        <span class="chip">${hint.rel || 'unknown'}</span>
        <span class="chip">${truncateUrl(hint.href || 'no-href', 20)}</span>
      </div>
      <div class="btns">
        <button class="btn" onclick="focusHint(${index})">üéØ Focus</button>
        <button class="btn ok" onclick="editHint(${index})">‚úèÔ∏è Edit</button>
      </div>
    </div>
  `).join('');
}

function getHintColor(rel) {
  const colors = {
    'preconnect': '#3b82f6',
    'dns-prefetch': '#06b6d4',
    'prefetch': '#8b5cf6',
    'preload': '#f59e0b'
  };
  return colors[rel] || '#6b7280';
}

function truncateUrl(url, maxLength) {
  if (url.length <= maxLength) return url;
  return url.substring(0, maxLength - 3) + '...';
}

function updateMatchesWindow() {
  if (state.hints.length === 0) {
    setCodeWindow('matchesCode', 'matchesGutter', '// No prefetch/preconnect hints found');
    return;
  }

  const content = state.hints.map((hint, index) => 
    `/* Match ${index + 1} - Line ${hint.line} - ${hint.rel} */\n${hint.raw}`
  ).join('\n\n');

  setCodeWindow('matchesCode', 'matchesGutter', content);
}

function updateLinesWindow() {
  if (state.hints.length === 0) {
    setCodeWindow('linesCode', 'linesGutter', '// No lines with hints found');
    return;
  }

  const content = state.hints.map((hint, index) => 
    `/* Line ${hint.line} - ${hint.rel} */\n${hint.lineText}`
  ).join('\n\n');

  setCodeWindow('linesCode', 'linesGutter', content);
}

function updateCounters() {
  const counts = state.hints.reduce((acc, hint) => {
    acc[hint.rel] = (acc[hint.rel] || 0) + 1;
    return acc;
  }, {});

  document.getElementById('count').textContent = `Found: ${state.hints.length}`;
  document.getElementById('kinds').textContent = 
    `${counts.preconnect || 0} preconnect ‚Ä¢ ${counts['dns-prefetch'] || 0} dns-prefetch ‚Ä¢ ${counts.prefetch || 0} prefetch ‚Ä¢ ${counts.preload || 0} preload`;
}

// Focus and editing functions
window.focusHint = function(index) {
  const hint = state.hints[index];
  if (!hint) return;

  highlightLine(hint.line);
  showMessage(`Focused on line ${hint.line}: ${hint.rel}`, 'success');
};

function highlightLine(targetLine) {
  // Highlight in lines window
  highlightInWindow('linesCode', 'linesGutter', targetLine);
  
  // Highlight in original document
  highlightInWindow('originalCode', 'originalGutter', targetLine);
}

function highlightInWindow(codeId, gutterId, targetLine) {
  const codeEl = document.getElementById(codeId);
  const gutterEl = document.getElementById(gutterId);
  
  if (!codeEl) return;
  
  const lines = codeEl.textContent.split('\n');
  let output = '';
  let currentLine = 1;
  
  lines.forEach(line => {
    // Check if this line indicates a line number in comments
    const lineMatch = line.match(/\/\* Line (\d+)/);
    if (lineMatch) {
      currentLine = parseInt(lineMatch[1], 10);
      output += escapeHtml(line) + '\n';
      return;
    }
    
    if (currentLine === targetLine) {
      output += `<span class="hi">${escapeHtml(line)}</span>\n`;
    } else {
      output += escapeHtml(line) + '\n';
    }
    
    currentLine++;
  });
  
  codeEl.innerHTML = output;
  
  // Scroll to highlighted line
  const lineHeight = 18;
  const scrollTop = Math.max(0, (targetLine - 5) * lineHeight);
  codeEl.scrollTop = scrollTop;
  gutterEl.scrollTop = scrollTop;
}

window.editHint = function(index) {
  const hint = state.hints[index];
  if (!hint) return;

  const modal = document.getElementById('modalContainer');
  modal.classList.remove('hidden');
  
  modal.innerHTML = `
    <div class="modal-backdrop">
      <div class="modal">
        <h3 style="margin-bottom: 16px; font-size: 18px;">Edit Resource Hint (Line ${hint.line})</h3>
        
        <div class="field">
          <div class="field-label">Relationship Type (rel)</div>
          <select id="editRel">
            <option value="preconnect" ${hint.rel === 'preconnect' ? 'selected' : ''}>preconnect</option>
            <option value="dns-prefetch" ${hint.rel === 'dns-prefetch' ? 'selected' : ''}>dns-prefetch</option>
            <option value="prefetch" ${hint.rel === 'prefetch' ? 'selected' : ''}>prefetch</option>
            <option value="preload" ${hint.rel === 'preload' ? 'selected' : ''}>preload</option>
          </select>
        </div>
        
        <div class="field">
          <div class="field-label">URL (href)</div>
          <input type="text" id="editHref" value="${hint.href || ''}" placeholder="https://example.com">
        </div>
        
        <div class="field">
          <div class="field-label">Resource Type (as) - for preload</div>
          <input type="text" id="editAs" value="${hint.as || ''}" placeholder="script, style, font, image, etc.">
        </div>
        
        <div class="field">
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="checkbox" id="editCrossorigin" ${hint.crossorigin ? 'checked' : ''}>
            <span>Include crossorigin attribute</span>
          </label>
        </div>
        
        <div class="row" style="justify-content: flex-end; margin-top: 20px; gap: 8px;">
          <button class="btn warn" onclick="deleteHint(${index})">üóëÔ∏è Delete</button>
          <button class="btn ok" onclick="saveHint(${index})">üíæ Save</button>
          <button class="btn" onclick="closeModal()">‚ùå Cancel</button>
        </div>
      </div>
    </div>
  `;
};

window.deleteHint = function(index) {
  state.hints.splice(index, 1);
  closeModal();
  updateAfterEdit();
  showMessage('Hint deleted', 'success');
};

window.saveHint = function(index) {
  const hint = state.hints[index];
  if (!hint) return;
  
  hint.rel = document.getElementById('editRel').value;
  hint.href = document.getElementById('editHref').value;
  hint.as = document.getElementById('editAs').value;
  hint.crossorigin = document.getElementById('editCrossorigin').checked;
  
  closeModal();
  updateAfterEdit();
  showMessage('Hint updated', 'success');
};

window.closeModal = function() {
  document.getElementById('modalContainer').classList.add('hidden');
};

function updateAfterEdit() {
  displayHints();
  updateMatchesWindow();
  updateLinesWindow();
  updateCounters();
  
  if (document.getElementById('autoApply').checked) {
    applyChanges();
  }
  
  document.getElementById('applyBtn').disabled = state.hints.length === 0;
}

// Apply changes function
function applyChanges() {
  if (!state.originalHTML) return;
  
  try {
    // Remove existing hints from original HTML
    let cleanHTML = state.originalHTML;
    
    // Remove all existing resource hint link tags
    cleanHTML = cleanHTML.replace(/<link\s+[^>]*>/gi, (match) => {
      const parsed = parseLinkTag(match);
      return isResourceHint(parsed.rel) ? '' : match;
    });
    
    // Clean up multiple empty lines
    cleanHTML = cleanHTML.replace(/\n\s*\n\s*\n/g, '\n\n');
    
    // Generate new hint tags
    const newHints = state.hints.map(hint => generateLinkTag(hint)).join('\n  ');
    
    // Insert new hints
    let result = cleanHTML;
    if (newHints) {
      const hintBlock = `\n  <!-- Resource hints -->\n  ${newHints}\n`;
      
      if (/<\/head>/i.test(result)) {
        result = result.replace(/<\/head>/i, hintBlock + '</head>');
      } else if (/<head[^>]*>/i.test(result)) {
        result = result.replace(/<head[^>]*>/i, match => match + hintBlock);
      } else {
        result = result.replace(/(<html[^>]*>)/i, '$1\n<head>' + hintBlock + '</head>');
      }
    }
    
    state.editedHTML = result;
    setCodeWindow('editedCode', 'editedGutter', state.editedHTML);
    updateChangesWindow();
    updatePreview(state.editedHTML);
    
    showMessage(`Applied ${state.hints.length} hints to document`, 'success');
    
  } catch (error) {
    console.error('Apply changes error:', error);
    showMessage('Error applying changes: ' + error.message, 'debug');
  }
}

function generateLinkTag(hint) {
  let attrs = [`rel="${hint.rel}"`, `href="${hint.href}"`];
  if (hint.as) attrs.push(`as="${hint.as}"`);
  if (hint.crossorigin) attrs.push('crossorigin');
  return `<link ${attrs.join(' ')}>`;
}

function updateChangesWindow() {
  const changes = compareHints(state.originalHints, state.hints);
  let content = '';
  
  if (changes.added.length > 0) {
    content += '/* ADDED HINTS */\n';
    changes.added.forEach(hint => {
      content += `+ ${generateLinkTag(hint)}\n`;
    });
    content += '\n';
  }
  
  if (changes.removed.length > 0) {
    content += '/* REMOVED HINTS */\n';
    changes.removed.forEach(hint => {
      content += `- (line ${hint.line}) ${generateLinkTag(hint)}\n`;
    });
    content += '\n';
  }
  
  if (changes.modified.length > 0) {
    content += '/* MODIFIED HINTS */\n';
    changes.modified.forEach(([original, modified]) => {
      content += `~ (line ${original.line})\n`;
      content += `  FROM: ${generateLinkTag(original)}\n`;
      content += `    TO: ${generateLinkTag(modified)}\n\n`;
    });
  }
  
  if (content === '') {
    content = '// No changes made yet';
  }
  
  setCodeWindow('changesCode', 'changesGutter', content);
}

function compareHints(original, current) {
  const createKey = hint => `${hint.rel}|${hint.href}|${hint.as}|${hint.crossorigin}`;
  
  const originalMap = new Map(original.map(h => [createKey(h), h]));
  const currentMap = new Map(current.map(h => [createKey(h), h]));
  
  const added = current.filter(h => !originalMap.has(createKey(h)));
  const removed = original.filter(h => !currentMap.has(createKey(h)));
  
  // Find modified (same href+rel, different attributes)
  const modified = [];
  const currentByHrefRel = new Map(current.map(h => [`${h.rel}|${h.href}`, h]));
  
  original.forEach(orig => {
    const key = createKey(orig);
    const hrefRelKey = `${orig.rel}|${orig.href}`;
    const curr = currentByHrefRel.get(hrefRelKey);
    
    if (curr && !currentMap.has(key)) {
      modified.push([orig, curr]);
    }
  });
  
  return { added, removed, modified };
}

// Preview functions
function updatePreview(html) {
  const iframe = document.getElementById('previewFrame');
  const url = createBlobUrl(html);
  iframe.src = url;
  setTimeout(() => URL.revokeObjectURL(url), 2000);
}

// Add new hint function
window.addNewHint = function() {
  const newHint = {
    rel: 'preconnect',
    href: 'https://example.com',
    as: '',
    crossorigin: false,
    raw: '',
    line: 1,
    lineText: '',
    startIndex: 0,
    endIndex: 0
  };
  
  state.hints.push(newHint);
  updateAfterEdit();
  showMessage('New hint added', 'success');
};

// Reset function
function resetAll() {
  state = {
    originalHTML: '',
    editedHTML: '',
    filename: '',
    hints: [],
    originalHints: [],
    isAnalyzed: false
  };
  
  // Reset UI
  document.getElementById('analyzeBtn').disabled = true;
  document.getElementById('applyBtn').disabled = true;
  document.getElementById('resetBtn').disabled = true;
  document.getElementById('downloadOrigBtn').disabled = true;
  document.getElementById('downloadEditedBtn').disabled = true;
  document.getElementById('analyzeBtn').textContent = 'üîç Analyze File';
  
  // Clear windows
  setCodeWindow('matchesCode', 'matchesGutter', '// Upload and analyze HTML to see extracted hints here');
  setCodeWindow('linesCode', 'linesGutter', '// Complete lines containing hints will appear here');
  setCodeWindow('originalCode', 'originalGutter', '// Your original HTML document will appear here');
  setCodeWindow('editedCode', 'editedGutter', '// Edited version with your changes will appear here');
  setCodeWindow('changesCode', 'changesGutter', '// Summary of all changes made will appear here');
  
  // Clear lists
  document.getElementById('hintsList').innerHTML = '<div class="meta">No prefetch/preconnect hints found yet.</div>';
  
  // Hide sections
  document.getElementById('hintsSection').classList.add('hidden');
  document.getElementById('statusMessage').classList.add('hidden');
  
  // Reset counters
  document.getElementById('count').textContent = 'Found: 0';
  document.getElementById('kinds').textContent = '0 preconnect ‚Ä¢ 0 dns-prefetch ‚Ä¢ 0 prefetch ‚Ä¢ 0 preload';
  
  // Clear preview
  document.getElementById('previewFrame').src = 'about:blank';
  
  showMessage('Reset complete - ready for new file', 'success');
}

// Event listeners setup
function setupEventListeners() {
  document.getElementById('analyzeBtn').addEventListener('click', analyzeHTML);
  document.getElementById('applyBtn').addEventListener('click', applyChanges);
  document.getElementById('resetBtn').addEventListener('click', resetAll);
  document.getElementById('addHintBtn').addEventListener('click', addNewHint);
  
  document.getElementById('previewOrigBtn').addEventListener('click', () => {
    if (state.originalHTML) updatePreview(state.originalHTML);
  });
  
  document.getElementById('previewEditedBtn').addEventListener('click', () => {
    if (state.editedHTML) updatePreview(state.editedHTML);
  });
  
  document.getElementById('downloadOrigBtn').addEventListener('click', () => {
    if (state.originalHTML && state.filename) {
      downloadFile(state.filename.replace(/\.html?$/i, '_original.html'), state.originalHTML);
    }
  });
  
  document.getElementById('downloadEditedBtn').addEventListener('click', () => {
    if (state.editedHTML && state.filename) {
      downloadFile(state.filename.replace(/\.html?$/i, '_edited.html'), state.editedHTML);
    }
  });
}

// Initialize everything
document.addEventListener('DOMContentLoaded', function() {
  console.log('Prefetch/Preconnect Inspector initialized');
  setupFileUpload();
  setupEventListeners();
  showMessage('Ready! Upload an HTML file to get started.', 'success');
});
</script>
</body>
</html>