<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>CodeMaster Pro ‚Äî CSS Standardizer Tool</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
  @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&display=swap');
  
  :root{
    --bg1:#0a0b0f;--bg2:#0f1419;--bg3:#161b22;--elev:#21262d;
    --txt:#f0f6fc;--muted:#9aa3ad;--muter:#7d8590;
    --pri:#58a6ff;--ok:#238636;--warn:#d29922;--err:#f85149;--pur:#bc8cff;--teal:#39d0d8;
    --bd:#30363d;--bdm:#21262d;--mono:'JetBrains Mono','Fira Code',Consolas,monospace;
  }
  
  *{box-sizing:border-box;margin:0;padding:0}
  body{background:linear-gradient(135deg,#0a0b0f,#1a1b23);color:var(--txt);font-family:Inter,system-ui,-apple-system,sans-serif;line-height:1.5}
  
  .header{background:linear-gradient(135deg,rgba(88,166,255,.08),rgba(188,140,255,.08));border-bottom:1px solid var(--bd);padding:20px;position:sticky;top:0;z-index:5}
  .header-inner{max-width:1400px;margin:0 auto;display:flex;align-items:center;justify-content:space-between}
  .header h1{font-size:22px;background:linear-gradient(135deg,var(--pri),var(--pur));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
  .stats{display:flex;gap:10px}
  .pill{background:rgba(255,255,255,.04);border:1px solid var(--bdm);border-radius:10px;padding:6px 10px;font-size:12px}

  .main{max-width:1400px;margin:0 auto;padding:24px;display:grid;grid-template-columns:400px 1fr;gap:24px;min-height:calc(100vh - 120px)}
  .panel{background:linear-gradient(145deg,var(--bg2),var(--bg3));border:1px solid var(--bd);border-radius:16px;padding:16px;box-shadow:0 8px 28px rgba(0,0,0,.25);display:flex;flex-direction:column;gap:14px;overflow-y:auto}
  .panel.left{max-height:calc(100vh - 160px)}
  .panel h2{font-size:16px;font-weight:600}
  
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .btn{display:inline-flex;gap:8px;align-items:center;justify-content:center;border:1px solid var(--bd);border-radius:10px;background:var(--elev);color:var(--txt);font-size:13px;font-weight:500;padding:8px 12px;cursor:pointer;transition:all 0.2s;text-decoration:none}
  .btn:hover:not(:disabled){transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,0.15)}
  .btn.primary{background:linear-gradient(135deg,var(--pri),var(--pur));border-color:transparent;color:white}
  .btn.ok{background:linear-gradient(135deg,var(--ok),var(--teal));border-color:transparent;color:white}
  .btn.warn{background:linear-gradient(135deg,var(--warn),#f59e0b);border-color:transparent;color:white}
  .btn:disabled{opacity:.55;cursor:not-allowed;transform:none}
  .btn.small{padding:6px 10px;font-size:12px}
  
  .upload{border:2px dashed var(--bd);border-radius:12px;padding:20px;text-align:center;cursor:pointer;background:linear-gradient(145deg,rgba(88,166,255,.04),rgba(188,140,255,.04));transition:all 0.3s ease;position:relative}
  .upload:hover{border-color:var(--pri);background:linear-gradient(145deg,rgba(88,166,255,.08),rgba(188,140,255,.08));transform:translateY(-2px)}
  .upload.drag{border-color:var(--teal);background:linear-gradient(145deg,rgba(57,208,216,.1),rgba(88,166,255,.1));transform:scale(1.02)}
  .upload-icon{font-size:20px;margin-bottom:8px}
  .meta{font-size:12px;color:var(--muter)}

  .list{display:flex;flex-direction:column;gap:6px;max-height:200px;overflow-y:auto}
  .item{border:1px solid var(--bdm);background:rgba(255,255,255,.03);border-radius:10px;padding:10px;display:flex;justify-content:space-between;align-items:center;gap:8px;transition:all 0.2s;cursor:pointer}
  .item:hover{background:rgba(255,255,255,.06);transform:translateY(-1px)}
  .item.selected{background:rgba(88,166,255,.1);border-color:var(--pri)}
  .item-info{flex:1;min-width:0}
  .item-name{font-weight:500;font-size:13px;margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .item-desc{font-size:11px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .item-actions{display:flex;gap:4px;flex-shrink:0}

  .batch-window{border:1px solid var(--bd);border-radius:12px;overflow:hidden;margin-top:8px}
  .batch-header{background:var(--elev);padding:10px;border-bottom:1px solid var(--bd);font-size:12px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px}
  .batch-content{display:grid;grid-template-columns:1fr 1fr;height:180px}
  .batch-panel{padding:8px;display:flex;flex-direction:column}
  .batch-panel.left{border-right:1px solid var(--bd)}
  .batch-list{flex:1;overflow-y:auto;border:1px solid var(--bdm);border-radius:6px;background:rgba(0,0,0,.2);padding:6px;font-family:var(--mono);font-size:11px}
  .batch-textarea{flex:1;background:rgba(0,0,0,.2);border:1px solid var(--bdm);border-radius:6px;padding:8px;color:var(--txt);font-family:var(--mono);font-size:11px;resize:none;outline:none}
  .batch-textarea:focus{border-color:var(--pri)}
  .batch-controls{padding:8px;background:var(--bg3);border-top:1px solid var(--bd);display:flex;gap:8px;justify-content:center}

  .win{background:#0b1320;border:1px solid #1c2740;border-radius:12px;overflow:hidden;margin-bottom:16px}
  .win-head{display:flex;align-items:center;gap:10px;padding:10px;background:#0e1622;border-bottom:1px solid #1c2740}
  .win-head .title{font-size:12px;color:#9aa3ad;font-weight:600;text-transform:uppercase;letter-spacing:0.5px}
  .win-body{display:flex;height:200px}
  .win.tall .win-body{height:280px}
  
  .gut{width:56px;background:#0b1320;border-right:1px solid #1c2740;color:#7c8aa8;font-family:var(--mono);font-size:12px;padding:8px 6px;overflow:auto;text-align:right;user-select:none;line-height:1.4}
  .code{flex:1;background:#0b1320;color:#cfe1ff;font-family:var(--mono);font-size:12px;padding:8px 10px;white-space:pre;overflow:auto;line-height:1.4;border:0;resize:none;outline:none}
  .code:focus{background:#0d1521}
  
  .hi{background:#243149 !important;outline:2px solid #3b82f6;box-shadow:0 0 0 2px rgba(59,130,246,.5) inset}
  
  .legend{margin-left:auto;display:flex;gap:8px}
  .flag{padding:2px 6px;border-radius:6px;border:1px solid var(--bdm);font-size:11px}
  .flag.add{background:rgba(35,134,54,.15);border-color:rgba(35,134,54,.3);color:#4ade80}
  .flag.del{background:rgba(248,81,73,.12);border-color:rgba(248,81,73,.35);color:#f87171}
  .flag.mod{background:rgba(210,153,34,.15);border-color:rgba(210,153,34,.35);color:#fbbf24}

  .preview{background:#0b1320;border:1px solid #1c2740;border-radius:12px;height:280px;overflow:hidden}
  .preview-head{display:flex;gap:10px;align-items:center;padding:10px;background:#0e1622;border-bottom:1px solid #1c2740}
  .dot{width:12px;height:12px;border-radius:50%}.dot.r{background:#f85149}.dot.y{background:#d29922}.dot.g{background:#238636}
  .preview iframe{width:100%;height:calc(100% - 44px);border:0;background:#fff}

  .hidden{display:none}
  
  .success{background:rgba(35,134,54,.1);border:1px solid rgba(35,134,54,.3);color:#4ade80;padding:8px;border-radius:8px;font-size:12px;margin:8px 0}
  .debug{background:rgba(248,81,73,.1);border:1px solid rgba(248,81,73,.3);color:#f87171;padding:8px;border-radius:8px;font-size:12px;margin:8px 0}
  
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center;z-index:1000}
  .modal{width:600px;max-width:95vw;background:#0e1622;border:1px solid #253043;border-radius:12px;box-shadow:0 30px 120px rgba(0,0,0,.45);padding:20px}
  .modal h3{font-size:18px;margin-bottom:16px;color:var(--txt)}
  .modal-content{margin:16px 0}
  .modal-code{background:var(--bg1);border:1px solid var(--bd);border-radius:8px;padding:12px;font-family:var(--mono);font-size:11px;max-height:200px;overflow-y:auto;margin:8px 0}
  .modal-old{color:#f87171}
  .modal-new{color:#4ade80}

  .css-rule{background:rgba(255,255,255,.02);border:1px solid var(--bdm);border-radius:8px;padding:8px;margin:4px 0;cursor:pointer;transition:all 0.2s;font-family:var(--mono);font-size:11px}
  .css-rule:hover{background:rgba(255,255,255,.05);transform:translateX(2px)}
  .css-rule.selected{background:rgba(88,166,255,.1);border-color:var(--pri)}
  .css-rule-name{font-weight:600;color:var(--pri);margin-bottom:4px}
  .css-rule-preview{color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
</style>
</head>
<body>
  <div class="header">
    <div class="header-inner">
      <h1>üé® CSS Standardizer Tool</h1>
      <div class="stats">
        <span class="pill" id="cssRulesCount">CSS Rules: 0</span>
        <span class="pill" id="filesCount">HTML Files: 0</span>
        <span class="pill" id="changesCount">Changes: 0</span>
      </div>
    </div>
  </div>

  <div class="main">
    <section class="panel left">
      <h2>üéØ CSS Style Management</h2>
      
      <!-- HTML Files Section -->
      <div class="upload" id="htmlDropZone">
        <div class="upload-icon">üìÑ</div>
        <div style="font-weight:600;margin-bottom:4px">Drop HTML Files Here</div>
        <div class="meta">Upload HTML files to analyze and extract CSS styles from &lt;style&gt; tags</div>
        <input type="file" id="htmlInput" accept=".html,.htm" multiple style="display:none">
      </div>
      
      <div class="row">
        <button class="btn primary" id="loadHtmlBtn">
          üìÅ Load HTML Files
        </button>
        <button class="btn ok" id="analyzeCssBtn" disabled>
          üîç Analyze CSS
        </button>
        <button class="btn warn" id="resetAllBtn" disabled>
          üîÑ Reset All
        </button>
      </div>
      
      <div id="statusMessage" class="hidden"></div>

      <!-- HTML Files List -->
      <div id="htmlFilesSection" class="hidden">
        <h2>üìÑ Loaded HTML Files</h2>
        <div class="list" id="htmlFilesList">
          <div class="meta">No HTML files loaded yet.</div>
        </div>
      </div>

      <!-- CSS Rules Analysis -->
      <div id="cssRulesSection" class="hidden">
        <h2>üìã Detected CSS Rules</h2>
        <div class="list" id="cssRulesList">
          <div class="meta">Load HTML files and analyze to see CSS rules.</div>
        </div>
      </div>

      <!-- CSS Batch Editor -->
      <div id="batchEditorSection" class="hidden">
        <h2>‚úèÔ∏è CSS Batch Editor</h2>
        <div class="batch-window">
          <div class="batch-header">CSS Rule Editor</div>
          <div class="batch-content">
            <div class="batch-panel left">
              <div style="font-size:11px;color:var(--muted);margin-bottom:4px">Select CSS to Replace:</div>
              <div class="batch-list" id="selectableCss">
                <div class="meta">Select a CSS rule to edit</div>
              </div>
            </div>
            <div class="batch-panel">
              <div style="font-size:11px;color:var(--muted);margin-bottom:4px">Paste New CSS:</div>
              <textarea class="batch-textarea" id="newCssTextarea" placeholder="Paste your replacement CSS here..."></textarea>
            </div>
          </div>
          <div class="batch-controls">
            <button class="btn primary small" id="previewReplaceBtn" disabled>üëÅÔ∏è Preview Replace</button>
            <button class="btn ok small" id="applyReplaceBtn" disabled>‚úÖ Apply Replace</button>
            <button class="btn small" id="clearSelectionBtn">üîÑ Clear Selection</button>
          </div>
        </div>
      </div>

    </section>

    <section class="panel">
      <h2>üíª Code Analysis & Preview</h2>

      <div class="win tall">
        <div class="win-head">
          <span class="title">üìÑ Original HTML Document</span>
        </div>
        <div class="win-body">
          <div class="gut" id="originalGutter"></div>
          <div class="code" id="originalCode">// Upload HTML files to see original document here</div>
        </div>
      </div>

      <div class="win tall">
        <div class="win-head">
          <span class="title">‚úèÔ∏è Edited Document (Live Updates)</span>
          <div class="legend">
            <span class="flag add">added</span>
            <span class="flag mod">modified</span>
            <span class="flag del">removed</span>
          </div>
        </div>
        <div class="win-body">
          <div class="gut" id="editedGutter"></div>
          <div class="code" id="editedCode">// Edited version with CSS changes will appear here</div>
        </div>
      </div>

      <div class="win">
        <div class="win-head">
          <span class="title">üìä Changes Summary (Old ‚Üí New)</span>
        </div>
        <div class="win-body">
          <div class="gut" id="changesGutter"></div>
          <div class="code" id="changesCode">// CSS changes will be tracked here</div>
        </div>
      </div>

      <div class="preview">
        <div class="preview-head">
          <div class="dot r"></div><div class="dot y"></div><div class="dot g"></div>
          <div class="meta" style="margin-left:8px">HTML Preview</div>
          <div class="row" style="margin-left:auto;gap:8px">
            <button class="btn" id="previewOrigBtn">üëÅÔ∏è Original</button>
            <button class="btn" id="previewEditedBtn">üëÅÔ∏è Edited</button>
            <button class="btn primary" id="downloadEditedBtn" disabled>üíæ Download Edited</button><button class="btn ok" id="applyToCodeMasterBtn">üì¶ Apply to CodeMaster</button>
            <button class="btn" id="downloadOrigBtn" disabled>üíæ Download Original</button>
          </div>
        </div>
        <iframe id="previewFrame" sandbox="allow-scripts allow-forms allow-modals allow-popups allow-presentation allow-same-origin" src="about:blank"></iframe>
      </div>
    </section>
  </div>

  <div id="modalContainer" class="hidden"></div>

<script>
// Global state
let state = {
  extractedCss: '',
  cssRules: [],
  htmlFiles: [],
  htmlContents: [], // Store loaded HTML contents
  currentHtmlIndex: 0,
  originalHTML: '',
  editedHTML: '',
  selectedCssRule: null,
  replacementRules: [],
  changes: []
};

// Utility functions
function showMessage(text, type = 'success') {
  const statusEl = document.getElementById('statusMessage');
  statusEl.className = type;
  statusEl.textContent = text;
  statusEl.classList.remove('hidden');
  setTimeout(() => statusEl.classList.add('hidden'), 4000);
}

function updateGutter(gutterId, text) {
  const lines = text.split('\n').length;
  let gutterText = '';
  for (let i = 1; i <= lines; i++) {
    gutterText += String(i).padStart(4, ' ') + '\n';
  }
  document.getElementById(gutterId).textContent = gutterText;
}

function setCodeWindow(codeId, gutterId, content) {
  const codeEl = document.getElementById(codeId);
  const gutterEl = document.getElementById(gutterId);
  codeEl.textContent = content;
  updateGutter(gutterId, content);
}

function escapeHtml(text) {
  return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

function createBlobUrl(content, type = 'text/html') {
  const blob = new Blob([content], { type });
  return URL.createObjectURL(blob);
}

function downloadFile(filename, content) {
  const url = createBlobUrl(content);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  setTimeout(() => URL.revokeObjectURL(url), 1000);
}

// HTML File Management and CSS Extraction
function setupHtmlUpload() {
  const htmlDropZone = document.getElementById('htmlDropZone');
  const htmlInput = document.getElementById('htmlInput');

  // Load HTML button
  document.getElementById('loadHtmlBtn').addEventListener('click', () => {
    htmlInput.click();
  });

  // HTML drop zone click
  htmlDropZone.addEventListener('click', () => {
    htmlInput.click();
  });

  // File input
  htmlInput.addEventListener('change', (e) => {
    if (e.target.files) {
      handleHtmlFiles(Array.from(e.target.files));
    }
  });

  // Drag and drop for HTML
  ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    htmlDropZone.addEventListener(eventName, preventDefaults, false);
  });

  function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
  }

  ['dragenter', 'dragover'].forEach(eventName => {
    htmlDropZone.addEventListener(eventName, () => {
      htmlDropZone.classList.add('drag');
    }, false);
  });

  ['dragleave', 'drop'].forEach(eventName => {
    htmlDropZone.addEventListener(eventName, () => {
      htmlDropZone.classList.remove('drag');
    }, false);
  });

  htmlDropZone.addEventListener('drop', (e) => {
    const files = Array.from(e.dataTransfer.files).filter(f => 
      f.name.toLowerCase().endsWith('.html') || f.name.toLowerCase().endsWith('.htm')
    );
    if (files.length > 0) {
      handleHtmlFiles(files);
    }
  }, false);
}

function handleHtmlFiles(files) {
  if (files.length === 0) return;
  
  state.htmlFiles = files;
  state.htmlContents = [];
  
  showMessage(`Loading ${files.length} HTML file(s)...`, 'success');
  
  // Load all HTML files
  let loadedCount = 0;
  const totalFiles = files.length;
  
  files.forEach((file, index) => {
    const reader = new FileReader();
    
    reader.onload = function(e) {
      try {
        const content = e.target.result;
        state.htmlContents[index] = content;
        loadedCount++;
        
        if (loadedCount === totalFiles) {
          // All files loaded, now display and enable CSS analysis
          displayHtmlFiles();
          document.getElementById('htmlFilesSection').classList.remove('hidden');
          document.getElementById('analyzeCssBtn').disabled = false;
          document.getElementById('resetAllBtn').disabled = false;
          
          // Load first file for preview
          if (state.htmlContents[0]) {
            loadHtmlFile(0);
          }
          
          showMessage(`Loaded ${totalFiles} HTML file(s) - Click "Analyze CSS" to extract styles`, 'success');
        }
        
      } catch (error) {
        console.error('Error loading HTML file:', error);
        showMessage(`Error loading ${file.name}: ${error.message}`, 'debug');
      }
    };
    
    reader.onerror = function() {
      showMessage(`Error reading ${file.name}`, 'debug');
    };
    
    reader.readAsText(file);
  });
  
  updateCounters();
}

function displayHtmlFiles() {
  const container = document.getElementById('htmlFilesList');
  
  if (state.htmlFiles.length === 0) {
    container.innerHTML = '<div class="meta">No HTML files loaded yet.</div>';
    return;
  }

  container.innerHTML = state.htmlFiles.map((file, index) => `
    <div class="item ${index === state.currentHtmlIndex ? 'selected' : ''}" onclick="loadHtmlFile(${index})">
      <div class="item-info">
        <div class="item-name">${escapeHtml(file.name)}</div>
        <div class="item-desc">${Math.round(file.size / 1024)}KB</div>
      </div>
      <div class="item-actions">
        <button class="btn small" onclick="event.stopPropagation(); loadHtmlFile(${index})">üëÅÔ∏è View</button>
      </div>
    </div>
  `).join('');
}

function loadHtmlFile(index) {
  if (!state.htmlContents[index]) return;
  
  state.currentHtmlIndex = index;
  const content = state.htmlContents[index];
  const file = state.htmlFiles[index];
  
  state.originalHTML = content;
  state.editedHTML = content;
  
  setCodeWindow('originalCode', 'originalGutter', state.originalHTML);
  setCodeWindow('editedCode', 'editedGutter', state.editedHTML);
  setCodeWindow('changesCode', 'changesGutter', '// No changes made yet');
  
  updatePreview(state.originalHTML);
  displayHtmlFiles(); // Refresh to show selection
  
  document.getElementById('downloadOrigBtn').disabled = false;
  
  showMessage(`Viewing ${file.name}`, 'success');
}

// CSS Extraction and Analysis
function analyzeCss() {
  if (state.htmlContents.length === 0) {
    showMessage('No HTML files loaded', 'debug');
    return;
  }

  const analyzeBtn = document.getElementById('analyzeCssBtn');
  analyzeBtn.disabled = true;
  analyzeBtn.textContent = 'üîç Analyzing...';

  try {
    // Extract CSS from all HTML files
    state.extractedCss = extractCssFromHtmlFiles();
    
    if (!state.extractedCss.trim()) {
      showMessage('No CSS found in the HTML files', 'debug');
      analyzeBtn.disabled = false;
      analyzeBtn.textContent = 'üîç Re-analyze CSS';
      return;
    }
    
    // Parse CSS rules
    state.cssRules = parseCssRules(state.extractedCss);
    
    displayCssRules();
    updateCounters();
    
    document.getElementById('cssRulesSection').classList.remove('hidden');
    document.getElementById('batchEditorSection').classList.remove('hidden');
    
    if (state.cssRules.length > 0) {
      showMessage(`Analyzed CSS: Found ${state.cssRules.length} rules from ${state.htmlFiles.length} HTML files`, 'success');
    } else {
      showMessage('No CSS rules found in the HTML files', 'debug');
    }

  } catch (error) {
    console.error('CSS analysis error:', error);
    showMessage('CSS analysis failed: ' + error.message, 'debug');
  }

  analyzeBtn.disabled = false;
  analyzeBtn.textContent = 'üîç Re-analyze CSS';
}

function extractCssFromHtmlFiles() {
  let allCss = '';
  
  state.htmlContents.forEach((htmlContent, index) => {
    const fileName = state.htmlFiles[index].name;
    
    // Extract CSS from <style> tags
    const styleRegex = /<style[^>]*>([\s\S]*?)<\/style>/gi;
    let match;
    
    while ((match = styleRegex.exec(htmlContent)) !== null) {
      const cssContent = match[1];
      if (cssContent.trim()) {
        allCss += `\n/* From ${fileName} */\n${cssContent}\n`;
      }
    }
  });
  
  return allCss;
}

function parseCssRules(cssContent) {
  const rules = [];
  
  // Remove comments first
  const cleanCss = cssContent.replace(/\/\*[\s\S]*?\*\//g, '');
  
  // Match CSS rules (selector { properties })
  const ruleRegex = /([^{}]+)\{([^{}]+)\}/g;
  let match;
  
  while ((match = ruleRegex.exec(cleanCss)) !== null) {
    const selector = match[1].trim();
    const properties = match[2].trim();
    
    if (selector && properties) {
      // Skip keyframes and other at-rules for now, but include keyframes
      if (!selector.startsWith('@') || selector.includes('keyframes')) {
        rules.push({
          selector: selector,
          properties: properties,
          fullRule: `${selector} {\n  ${properties.replace(/;/g, ';\n  ')}\n}`,
          id: Date.now() + Math.random()
        });
      }
    }
  }
  
  return rules;
}

function displayCssRules() {
  const container = document.getElementById('cssRulesList');
  
  if (state.cssRules.length === 0) {
    container.innerHTML = '<div class="meta">No CSS rules found in HTML files.</div>';
    return;
  }

  container.innerHTML = state.cssRules.map((rule, index) => `
    <div class="css-rule" onclick="selectCssRule(${index})">
      <div class="css-rule-name">${escapeHtml(rule.selector)}</div>
      <div class="css-rule-preview">${escapeHtml(rule.properties.substring(0, 50))}${rule.properties.length > 50 ? '...' : ''}</div>
    </div>
  `).join('');
}

// CSS Rule Selection and Editing
window.selectCssRule = function(index) {
  const rule = state.cssRules[index];
  if (!rule) return;
  
  state.selectedCssRule = rule;
  
  // Update UI
  document.querySelectorAll('.css-rule').forEach((el, i) => {
    el.classList.toggle('selected', i === index);
  });
  
  // Show rule in batch editor
  const selectableDiv = document.getElementById('selectableCss');
  selectableDiv.innerHTML = `
    <div class="css-rule selected">
      <div class="css-rule-name">${escapeHtml(rule.selector)}</div>
      <pre style="color:var(--muted);font-size:10px;margin-top:4px;white-space:pre-wrap">${escapeHtml(rule.fullRule)}</pre>
    </div>
  `;
  
  document.getElementById('previewReplaceBtn').disabled = false;
  document.getElementById('clearSelectionBtn').disabled = false;
  
  showMessage(`Selected CSS rule: ${rule.selector}`, 'success');
};

window.clearSelection = function() {
  state.selectedCssRule = null;
  
  document.querySelectorAll('.css-rule').forEach(el => {
    el.classList.remove('selected');
  });
  
  document.getElementById('selectableCss').innerHTML = '<div class="meta">Select a CSS rule to edit</div>';
  document.getElementById('newCssTextarea').value = '';
  document.getElementById('previewReplaceBtn').disabled = true;
  document.getElementById('applyReplaceBtn').disabled = true;
  document.getElementById('clearSelectionBtn').disabled = true;
  
  showMessage('Selection cleared', 'success');
};

function previewReplace() {
  if (!state.selectedCssRule) {
    showMessage('No CSS rule selected', 'debug');
    return;
  }
  
  const newCss = document.getElementById('newCssTextarea').value.trim();
  if (!newCss) {
    showMessage('Please enter replacement CSS', 'debug');
    return;
  }
  
  showConfirmModal(state.selectedCssRule, newCss, false);
}

function applyReplace() {
  if (!state.selectedCssRule) {
    showMessage('No CSS rule selected', 'debug');
    return;
  }
  
  const newCss = document.getElementById('newCssTextarea').value.trim();
  if (!newCss) {
    showMessage('Please enter replacement CSS', 'debug');
    return;
  }
  
  showConfirmModal(state.selectedCssRule, newCss, true);
}

function showConfirmModal(oldRule, newCss, applyChanges) {
  const modal = document.getElementById('modalContainer');
  modal.classList.remove('hidden');
  
  const actionText = applyChanges ? 'replace' : 'preview replacement of';
  
  modal.innerHTML = `
    <div class="modal-backdrop">
      <div class="modal">
        <h3>${applyChanges ? 'üîÑ' : 'üëÅÔ∏è'} Confirm CSS ${applyChanges ? 'Replacement' : 'Preview'}</h3>
        
        <div class="modal-content">
          <p>Do you want to ${actionText} this CSS rule?</p>
          
          <div style="margin: 16px 0;">
            <div style="font-weight: 600; color: #f87171; margin-bottom: 8px;">OLD CSS:</div>
            <div class="modal-code modal-old">${escapeHtml(oldRule.fullRule)}</div>
          </div>
          
          <div style="margin: 16px 0;">
            <div style="font-weight: 600; color: #4ade80; margin-bottom: 8px;">NEW CSS:</div>
            <div class="modal-code modal-new">${escapeHtml(newCss)}</div>
          </div>
        </div>
        
        <div class="row" style="justify-content: flex-end; margin-top: 20px; gap: 8px;">
          <button class="btn" onclick="closeModal()">‚ùå Cancel</button>
          <button class="btn ${applyChanges ? 'ok' : 'primary'}" onclick="${applyChanges ? 'confirmApplyReplace' : 'confirmPreviewReplace'}()">
            ${applyChanges ? '‚úÖ Apply Changes' : 'üëÅÔ∏è Preview Changes'}
          </button>
        </div>
      </div>
    </div>
  `;
}

window.confirmPreviewReplace = function() {
  const newCss = document.getElementById('newCssTextarea').value.trim();
  previewCssReplacement(state.selectedCssRule, newCss);
  closeModal();
};

window.confirmApplyReplace = function() {
  const newCss = document.getElementById('newCssTextarea').value.trim();
  applyCssReplacement(state.selectedCssRule, newCss);
  closeModal();
};

window.closeModal = function() {
  document.getElementById('modalContainer').classList.add('hidden');
};

function previewCssReplacement(oldRule, newCss) {
  if (!state.originalHTML) {
    showMessage('No HTML file loaded', 'debug');
    return;
  }
  
  try {
    const previewHTML = replaceCssInHtml(state.originalHTML, oldRule, newCss);
    updatePreview(previewHTML);
    
    // Show preview in changes window
    const changesSummary = `/* PREVIEW - Changes not applied yet */\n\n/* OLD CSS (${oldRule.selector}) */\n${oldRule.fullRule}\n\n/* NEW CSS */\n${newCss}`;
    setCodeWindow('changesCode', 'changesGutter', changesSummary);
    
    document.getElementById('applyReplaceBtn').disabled = false;
    showMessage('Preview updated - check the preview window', 'success');
    
  } catch (error) {
    console.error('Preview error:', error);
    showMessage('Preview failed: ' + error.message, 'debug');
  }
}

function applyCssReplacement(oldRule, newCss) {
  if (!state.originalHTML) {
    showMessage('No HTML file loaded', 'debug');
    return;
  }
  
  try {
    state.editedHTML = replaceCssInHtml(state.originalHTML, oldRule, newCss);
    setCodeWindow('editedCode', 'editedGutter', state.editedHTML);
    
    // Track the change
    const change = {
      selector: oldRule.selector,
      oldCss: oldRule.fullRule,
      newCss: newCss,
      timestamp: new Date()
    };
    
    state.changes.push(change);
    updateChangesWindow();
    updatePreview(state.editedHTML);
    updateCounters();
    
    // Clear the editor
    document.getElementById('newCssTextarea').value = '';
    clearSelection();
    
    document.getElementById('downloadEditedBtn').disabled = false;
    showMessage(`Applied CSS replacement for ${oldRule.selector}`, 'success');
    
  } catch (error) {
    console.error('Apply error:', error);
    showMessage('Apply failed: ' + error.message, 'debug');
  }
}

function replaceCssInHtml(html, oldRule, newCss) {
  // Find and replace CSS within <style> tags
  const styleRegex = /<style[^>]*>([\s\S]*?)<\/style>/gi;
  
  return html.replace(styleRegex, (match, cssContent) => {
    // Look for the specific CSS rule
    const ruleRegex = new RegExp(
      oldRule.selector.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + 
      '\\s*\\{[^{}]*\\}', 'gi'
    );
    
    const updatedCss = cssContent.replace(ruleRegex, newCss);
    return `<style>${updatedCss}</style>`;
  });
}

function updateChangesWindow() {
  if (state.changes.length === 0) {
    setCodeWindow('changesCode', 'changesGutter', '// No changes made yet');
    return;
  }
  
  const changesText = state.changes.map((change, index) => {
    return `/* Change ${index + 1}: ${change.selector} */\n\n/* OLD CSS */\n${change.oldCss}\n\n/* NEW CSS */\n${change.newCss}\n\n${'='.repeat(60)}\n`;
  }).join('\n');
  
  setCodeWindow('changesCode', 'changesGutter', changesText);
}

// Preview and Download
function updatePreview(html) {
  const iframe = document.getElementById('previewFrame');
  const url = createBlobUrl(html);
  iframe.src = url;
  setTimeout(() => URL.revokeObjectURL(url), 2000);
}

function updateCounters() {
  document.getElementById('cssRulesCount').textContent = `CSS Rules: ${state.cssRules.length}`;
  document.getElementById('filesCount').textContent = `HTML Files: ${state.htmlFiles.length}`;
  document.getElementById('changesCount').textContent = `Changes: ${state.changes.length}`;
}

// Reset function
function resetAll() {
  state = {
    extractedCss: '',
    cssRules: [],
    htmlFiles: [],
    htmlContents: [],
    currentHtmlIndex: 0,
    originalHTML: '',
    editedHTML: '',
    selectedCssRule: null,
    replacementRules: [],
    changes: []
  };
  
  // Reset UI
  document.getElementById('analyzeCssBtn').disabled = true;
  document.getElementById('resetAllBtn').disabled = true;
  document.getElementById('downloadOrigBtn').disabled = true;
  document.getElementById('downloadEditedBtn').disabled = true;
  document.getElementById('previewReplaceBtn').disabled = true;
  document.getElementById('applyReplaceBtn').disabled = true;
  document.getElementById('clearSelectionBtn').disabled = true;
  document.getElementById('analyzeCssBtn').textContent = 'üîç Analyze CSS';
  
  // Clear windows
  setCodeWindow('originalCode', 'originalGutter', '// Upload HTML files to see original document here');
  setCodeWindow('editedCode', 'editedGutter', '// Edited version with CSS changes will appear here');
  setCodeWindow('changesCode', 'changesGutter', '// CSS changes will be tracked here');
  
  // Clear lists
  document.getElementById('cssRulesList').innerHTML = '<div class="meta">Load HTML files and analyze to see CSS rules.</div>';
  document.getElementById('htmlFilesList').innerHTML = '<div class="meta">No HTML files loaded yet.</div>';
  document.getElementById('selectableCss').innerHTML = '<div class="meta">Select a CSS rule to edit</div>';
  document.getElementById('newCssTextarea').value = '';
  
  // Hide sections
  document.getElementById('cssRulesSection').classList.add('hidden');
  document.getElementById('htmlFilesSection').classList.add('hidden');
  document.getElementById('batchEditorSection').classList.add('hidden');
  document.getElementById('statusMessage').classList.add('hidden');
  
  // Reset counters
  updateCounters();
  
  // Clear preview
  document.getElementById('previewFrame').src = 'about:blank';
  
  showMessage('Reset complete - ready for HTML files', 'success');
}

// Event listeners setup
function setupEventListeners() {
  document.getElementById('analyzeCssBtn').addEventListener('click', analyzeCss);
  document.getElementById('resetAllBtn').addEventListener('click', resetAll);
  document.getElementById('previewReplaceBtn').addEventListener('click', previewReplace);
  document.getElementById('applyReplaceBtn').addEventListener('click', applyReplace);
  document.getElementById('clearSelectionBtn').addEventListener('click', clearSelection);
  
  document.getElementById('previewOrigBtn').addEventListener('click', () => {
    if (state.originalHTML) updatePreview(state.originalHTML);
  });
  
  document.getElementById('previewEditedBtn').addEventListener('click', () => {
    if (state.editedHTML) updatePreview(state.editedHTML);
  });
  
  document.getElementById('downloadOrigBtn').addEventListener('click', () => {
    if (state.originalHTML && state.htmlFiles[state.currentHtmlIndex]) {
      const filename = state.htmlFiles[state.currentHtmlIndex].name.replace(/\.html?$/i, '_original.html');
      downloadFile(filename, state.originalHTML);
    }
  });
  
  document.getElementById('downloadEditedBtn').addEventListener('click', () => {
    if (state.editedHTML && state.htmlFiles[state.currentHtmlIndex]) {
      const filename = state.htmlFiles[state.currentHtmlIndex].name.replace(/\.html?$/i, '_edited.html');
      downloadFile(filename, state.editedHTML);
    }
  });
}

// Initialize everything
document.addEventListener('DOMContentLoaded', function() {
  console.log('CSS Standardizer Tool initialized');
  setupHtmlUpload();
  setupEventListeners();
  showMessage('Ready! Upload HTML files to extract and analyze CSS styles.', 'success');
});
// ===== Workshop Mode Wiring =====
(function(){
  const params = new URLSearchParams(location.search);
  const inWorkshop = params.get('mode') === 'workshop';

  if (inWorkshop) {
    showMessage('Workshop mode: awaiting code from CodeMaster‚Ä¶', 'success');
    window.parent && window.parent.postMessage({ type: 'WORKSHOP_REQUEST_CODE' }, '*');
  }

  window.addEventListener('message', function(e){
    const msg = e.data || {};
    if (msg.type === 'INJECT_HTML' && typeof msg.content === 'string') {
      try {
        state.htmlFiles = [{ name: msg.name || 'Injected.html', size: msg.content.length }];
        state.htmlContents = [ msg.content ];
        state.currentHtmlIndex = 0;
        state.originalHTML = msg.content;
        state.editedHTML = msg.content;

        setCodeWindow('originalCode', 'originalGutter', state.originalHTML);
        setCodeWindow('editedCode', 'editedGutter', state.editedHTML);
        setCodeWindow('changesCode', 'changesGutter', '// No changes made yet');
        document.getElementById('downloadOrigBtn').disabled = false;

        document.getElementById('htmlFilesSection').classList.remove('hidden');
        document.getElementById('cssRulesSection').classList.remove('hidden');
        document.getElementById('batchEditorSection').classList.remove('hidden');
        document.getElementById('analyzeCssBtn').disabled = false;
        document.getElementById('resetAllBtn').disabled = false;

        displayHtmlFiles();
        updatePreview(state.originalHTML);
        showMessage('Received HTML from CodeMaster. Ready to analyze.', 'success');
      } catch (err) {
        console.error(err);
        showMessage('Error injecting HTML from CodeMaster: ' + err.message, 'debug');
      }
    }
  });

  var applyBtn = document.getElementById('applyToCodeMasterBtn');
  if (applyBtn) {
    applyBtn.addEventListener('click', function(){
      if (!state.editedHTML || typeof state.editedHTML !== 'string') {
        showMessage('No edited HTML to apply', 'debug');
        return;
      }
      window.parent && window.parent.postMessage({
        type: 'WORKSHOP_APPLY_PATCH',
        content: state.editedHTML
      }, '*');
      showMessage('Sent edited HTML back to CodeMaster', 'success');
    });
  }

  window.parent && window.parent.postMessage({ type: 'WORKSHOP_READY' }, '*');
})();

</script>
</body>
</html>